<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstudosPRO - TJPR 2025</title>
    <style>
        :root { --bg-primary: #0a0f1c; --bg-secondary: #111827; --bg-card: #1a2235; --accent: #6366f1; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --cyan: #06b6d4; --text: #f1f5f9; --text-sec: #94a3b8; --text-muted: #64748b; --border: #2d3a52; }
        [data-theme="light"] { --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-card: #ffffff; --text: #1e293b; --text-sec: #475569; --text-muted: #64748b; --border: #e2e8f0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: var(--bg-primary); color: var(--text); min-height: 100vh; }
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 20px 12px; position: fixed; height: 100vh; overflow-y: auto; }
        .logo { font-size: 1.1rem; font-weight: 700; color: var(--accent); padding: 0 8px; }
        .logo-sub { font-size: 0.7rem; color: var(--text-muted); padding: 0 8px; margin-bottom: 24px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: var(--text-sec); font-size: 0.9rem; margin-bottom: 2px; }
        .nav-item:hover { background: var(--bg-card); color: var(--text); }
        .nav-item.active { background: var(--accent); color: white; }
        .nav-badge { margin-left: auto; background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 8px; }
        .nav-section { margin-top: 20px; margin-bottom: 8px; padding: 0 12px; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .main { flex: 1; margin-left: 220px; padding: 24px; }
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
        .page-sub { color: var(--text-sec); font-size: 0.9rem; margin-bottom: 24px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.purple::before { background: linear-gradient(90deg, var(--accent), #8b5cf6); }
        .stat-card.green::before { background: linear-gradient(90deg, var(--success), var(--cyan)); }
        .stat-card.orange::before { background: linear-gradient(90deg, var(--warning), var(--danger)); }
        .stat-card.blue::before { background: linear-gradient(90deg, var(--cyan), #3b82f6); }
        .stat-label { font-size: 0.8rem; color: var(--text-sec); margin-bottom: 8px; }
        .stat-value { font-size: 1.75rem; font-weight: 700; }
        .stat-card.purple .stat-value { color: var(--accent); }
        .stat-card.green .stat-value { color: var(--success); }
        .stat-card.orange .stat-value { color: var(--warning); }
        .stat-card.blue .stat-value { color: var(--cyan); }
        .stat-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .progress-bar { height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #8b5cf6); border-radius: 4px; transition: width 0.3s; }
        .progress-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-sec); }
        .goal-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
        .goal-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .goal-icon.hours { background: rgba(99, 102, 241, 0.15); }
        .goal-icon.topics { background: rgba(16, 185, 129, 0.15); }
        .goal-icon.questions { background: rgba(245, 158, 11, 0.15); }
        .goal-info { flex: 1; }
        .goal-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
        .goal-progress { font-size: 0.75rem; color: var(--text-muted); }
        .goal-pct { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
        .btn { padding: 10px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #5558e3; }
        .btn-secondary { background: var(--bg-primary); color: var(--text-sec); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); color: var(--text); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-sec); margin-bottom: 6px; font-weight: 500; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; font-family: inherit; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
        .form-textarea { min-height: 100px; resize: vertical; }
        .timer-display { font-family: monospace; font-size: 3rem; font-weight: 700; text-align: center; padding: 24px; background: var(--bg-primary); border-radius: 12px; margin-bottom: 20px; color: var(--accent); }
        .timer-controls { display: flex; gap: 10px; justify-content: center; margin-top: 16px; }
        .session-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
        .session-time { font-family: monospace; font-size: 1rem; font-weight: 600; color: var(--accent); min-width: 70px; }
        .session-info { flex: 1; }
        .session-subject { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
        .session-topic { font-size: 0.8rem; color: var(--text-sec); }
        .session-date { font-size: 0.75rem; color: var(--text-muted); }
        .session-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .session-delete:hover { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .empty { text-align: center; padding: 32px; color: var(--text-muted); }
        .empty-icon { font-size: 2rem; margin-bottom: 8px; opacity: 0.5; }
        .toast-container { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .toast { padding: 12px 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-weight: 500; animation: toastIn 0.3s; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .disc-item { margin-bottom: 16px; }
        .disc-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .disc-name { font-size: 0.85rem; }
        .disc-pct { font-size: 0.8rem; color: var(--accent); font-weight: 600; }
        .disc-bar { height: 6px; background: var(--bg-primary); border-radius: 3px; overflow: hidden; }
        .disc-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #8b5cf6); border-radius: 3px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-backdrop.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: modalIn 0.3s; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close { background: var(--bg-primary); border: none; color: var(--text-muted); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .modal-close:hover { color: var(--danger); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
        /* ACCORDION CORRIGIDO */
        .accordion { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 12px; }
        .accordion-header { padding: 16px; background: var(--bg-primary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-header:hover { background: var(--bg-card); }
        .accordion-title { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .accordion-meta { font-size: 0.8rem; color: var(--text-muted); }
        .accordion-arrow { transition: transform 0.3s; }
        .accordion.open .accordion-arrow { transform: rotate(180deg); }
        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .accordion.open .accordion-body { max-height: 2000px; overflow-y: auto; }
        .accordion-content { padding: 16px; border-top: 1px solid var(--border); }
        /* TOPIC ITEM */
        .topic-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: var(--bg-card); border-radius: 8px; margin-bottom: 6px; }
        .topic-num { font-size: 0.8rem; color: var(--text-muted); min-width: 28px; font-weight: 600; }
        .topic-name { flex: 1; font-size: 0.85rem; }
        .topic-status { display: flex; gap: 6px; }
        .status-btn { width: 28px; height: 28px; border-radius: 6px; border: 2px solid var(--border); background: transparent; cursor: pointer; font-size: 0.7rem; transition: all 0.2s; color: var(--text-muted); }
        .status-btn:hover { border-color: var(--text-sec); }
        .status-btn.active { border-color: transparent; color: white; }
        .status-btn.s1.active { background: var(--text-muted); }
        .status-btn.s2.active { background: var(--accent); }
        .status-btn.s3.active { background: var(--warning); }
        .status-btn.s4.active { background: var(--success); }
        .topic-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 1rem; }
        .topic-delete:hover { color: var(--danger); }
        .status-legend { display: flex; gap: 16px; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 12px; font-size: 0.75rem; color: var(--text-sec); flex-wrap: wrap; }
        .status-legend span { display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 10px; height: 10px; border-radius: 3px; }
        .status-dot.s1 { background: var(--text-muted); }
        .status-dot.s2 { background: var(--accent); }
        .status-dot.s3 { background: var(--warning); }
        .status-dot.s4 { background: var(--success); }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; background: var(--bg-primary); color: var(--text-sec); border: 1px solid var(--border); transition: all 0.2s; }
        .tab:hover { border-color: var(--accent); color: var(--text); }
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        .tab .tab-count { margin-left: 6px; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; background: rgba(255,255,255,0.2); }
        .review-item { display: flex; align-items: center; gap: 14px; padding: 16px; background: var(--bg-primary); border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--border); }
        .review-item.pending { border-left-color: var(--warning); }
        .review-item.overdue { border-left-color: var(--danger); }
        .review-item.done { border-left-color: var(--success); opacity: 0.7; }
        .review-date { text-align: center; min-width: 55px; }
        .review-day { font-size: 1.4rem; font-weight: 700; color: var(--accent); }
        .review-month { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }
        .review-info { flex: 1; }
        .review-subject { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; }
        .review-topic { font-size: 0.8rem; color: var(--text-sec); }
        .review-interval { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
        .badge { padding: 5px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .badge-pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .badge-overdue { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge-done { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .review-actions { display: flex; gap: 8px; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .main { margin-left: 0; } .stats-grid { grid-template-columns: 1fr; } .tabs { flex-wrap: wrap; } }
    
        /* Ciclos */
        .ciclo-disc-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; margin-bottom: 6px; background: var(--bg-card); }
        .ciclo-disc-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
        .ciclo-disc-name { flex: 1; font-size: 0.85rem; cursor: pointer; }
        .ciclo-disc-peso { font-size: 0.75rem; color: var(--text-muted); background: var(--bg-primary); padding: 2px 8px; border-radius: 4px; }
        .ciclo-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .ciclo-step { padding: 10px 14px; background: var(--bg-primary); border-radius: 8px; font-size: 0.8rem; border-left: 4px solid var(--accent); min-width: 160px; transition: all 0.2s; }
        .ciclo-step.done { opacity: 0.5; background: var(--bg-card); }
        .ciclo-step.done .ciclo-step-disc { text-decoration: line-through; }
        .ciclo-step.current { box-shadow: 0 0 0 2px var(--warning); background: rgba(245, 158, 11, 0.1); }
        .ciclo-step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .ciclo-step-num { font-size: 0.65rem; color: var(--text-muted); }
        .ciclo-step-disc { font-weight: 600; }
        .ciclo-step-tempo { font-size: 0.7rem; color: var(--cyan); margin-top: 2px; }
        .ciclo-step-actions { display: flex; gap: 4px; }
        .ciclo-btn { width: 22px; height: 22px; border-radius: 4px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; font-size: 0.7rem; transition: all 0.2s; }
        .ciclo-btn:hover { border-color: var(--accent); color: var(--text); }
        .ciclo-btn.active { background: var(--success); border-color: var(--success); color: white; }
        .ciclo-step.current .ciclo-btn.active { background: var(--warning); border-color: var(--warning); }
        .ciclo-progress-bar { height: 10px; background: var(--bg-primary); border-radius: 5px; overflow: hidden; margin-bottom: 8px; }
        .ciclo-progress-fill { height: 100%; background: linear-gradient(90deg, var(--success), var(--cyan)); border-radius: 5px; transition: width 0.3s; }
        .ciclo-progress-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-sec); margin-bottom: 16px; }
        .ciclo-legenda-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.8rem; }
        .ciclo-legenda-cor { width: 14px; height: 14px; border-radius: 4px; }
        .ciclo-legenda-info { flex: 1; }
        .ciclo-legenda-tempo { color: var(--text-muted); font-size: 0.75rem; }
    
        /* Quest√µes */
        .questao-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
        .questao-data { font-size: 0.75rem; color: var(--text-muted); min-width: 70px; }
        .questao-info { flex: 1; }
        .questao-disc { font-weight: 600; font-size: 0.9rem; }
        .questao-fonte { font-size: 0.75rem; color: var(--text-sec); }
        .questao-resultado { text-align: right; min-width: 80px; }
        .questao-taxa { font-size: 1.1rem; font-weight: 700; }
        .questao-detalhe { font-size: 0.7rem; color: var(--text-muted); }
        .questao-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .questao-delete:hover { color: var(--danger); }
        .disc-rank-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
        .disc-rank-pos { font-size: 0.8rem; color: var(--text-muted); min-width: 24px; }
        .disc-rank-name { flex: 1; font-size: 0.85rem; }
        .disc-rank-bar { width: 100px; height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden; }
        .disc-rank-fill { height: 100%; border-radius: 3px; }
        .disc-rank-taxa { font-size: 0.85rem; font-weight: 600; min-width: 45px; text-align: right; }
        .disc-rank-count { font-size: 0.7rem; color: var(--text-muted); min-width: 50px; text-align: right; }
    
        /* Estat√≠sticas */
        .stats-bar-container { margin-bottom: 12px; }
        .stats-bar-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; }
        .stats-bar-name { color: var(--text); }
        .stats-bar-value { color: var(--accent); font-weight: 600; }
        .stats-bar { height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; }
        .stats-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .stats-day-col { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .stats-day-value { font-size: 0.7rem; color: var(--text-sec); margin-bottom: 4px; }
        .stats-day-bar-wrap { flex: 1; display: flex; align-items: flex-end; }
        .stats-day-fill { width: 28px; background: linear-gradient(180deg, var(--accent), #8b5cf6); border-radius: 4px 4px 0 0; transition: height 0.3s; min-height: 2px; }
        .stats-day-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; }
        .stats-summary-item { display: flex; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
        .stats-summary-label { color: var(--text-sec); font-size: 0.85rem; }
        .stats-summary-value { font-weight: 600; color: var(--text); }
        .meta-progress-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-primary); border-radius: 10px; margin-bottom: 12px; }
        .meta-progress-icon { font-size: 1.5rem; }
        .meta-progress-info { flex: 1; }
        .meta-progress-title { font-weight: 600; margin-bottom: 4px; }
        .meta-progress-bar { height: 8px; background: var(--bg-card); border-radius: 4px; overflow: hidden; }
        .meta-progress-fill { height: 100%; border-radius: 4px; }
        .meta-progress-text { font-size: 0.8rem; color: var(--text-sec); margin-top: 4px; }
        .meta-progress-pct { font-size: 1.25rem; font-weight: 700; min-width: 60px; text-align: right; }
    
        /* Theme Toggle */
        .theme-toggle { width: 100%; padding: 10px; margin-bottom: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-size: 1rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .theme-toggle:hover { border-color: var(--accent); }
        .theme-toggle::after { content: 'Tema Escuro'; font-size: 0.8rem; }
        [data-theme="light"] .theme-toggle::after { content: 'Tema Claro'; }
    
        /* Streak e XP */
        .streak-xp-bar { display: grid; grid-template-columns: auto 1fr auto; gap: 16px; margin-bottom: 20px; }
        .streak-card { display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #f59e0b22, #ef444422); border: 1px solid var(--warning); border-radius: 12px; padding: 16px 20px; }
        .streak-icon { font-size: 2rem; }
        .streak-value { font-size: 1.75rem; font-weight: 700; color: var(--warning); }
        .streak-label { font-size: 0.75rem; color: var(--text-sec); }
        .xp-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; }
        .xp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .xp-level { font-weight: 700; color: var(--accent); }
        .xp-title { font-size: 0.8rem; color: var(--text-sec); }
        .xp-bar { height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--cyan)); border-radius: 4px; transition: width 0.5s; }
        .xp-text { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; text-align: center; }
        .badges-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-width: 200px; }
        .badges-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 10px; }
        .badges-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .badge-item { font-size: 1.25rem; opacity: 0.3; transition: all 0.2s; cursor: default; }
        .badge-item.earned { opacity: 1; transform: scale(1.1); }
        .badge-item:hover::after { content: attr(title); position: absolute; background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; margin-top: 24px; margin-left: -20px; }
        @media (max-width: 900px) { .streak-xp-bar { grid-template-columns: 1fr; } }
    
        /* Pomodoro */
        .pomodoro-toggle { display: flex; align-items: center; gap: 8px; }
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 24px; transition: 0.3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background: var(--text-muted); border-radius: 50%; transition: 0.3s; }
        .toggle-switch input:checked + .toggle-slider { background: var(--danger); border-color: var(--danger); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); background: white; }
        .pomodoro-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .pomodoro-badge.foco { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .pomodoro-badge.pausa { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .pomodoro-badge.longa { background: rgba(99, 102, 241, 0.15); color: var(--accent); }
    
        /* Comparativo */
        .comparativo-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
        .comparativo-label { flex: 1; font-size: 0.85rem; }
        .comparativo-values { display: flex; gap: 16px; align-items: center; }
        .comparativo-old { font-size: 0.85rem; color: var(--text-muted); min-width: 50px; text-align: right; }
        .comparativo-arrow { font-size: 1rem; }
        .comparativo-new { font-size: 0.95rem; font-weight: 600; min-width: 50px; }
        .comparativo-diff { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; }
        .comparativo-diff.up { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .comparativo-diff.down { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .comparativo-diff.same { background: rgba(100, 116, 139, 0.15); color: var(--text-muted); }
        .previsao-card { text-align: center; padding: 20px; background: var(--bg-primary); border-radius: 12px; margin-bottom: 12px; }
        .previsao-data { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
        .previsao-dias { font-size: 0.85rem; color: var(--text-sec); margin-top: 4px; }
        .previsao-item { display: flex; justify-content: space-between; padding: 10px 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 6px; font-size: 0.85rem; }
    
        /* Anota√ß√µes e Links */
        .topic-note-btn { background: none; border: none; cursor: pointer; font-size: 0.85rem; opacity: 0.4; transition: all 0.2s; padding: 4px; }
        .topic-note-btn:hover { opacity: 1; }
        .topic-note-btn.has-note { opacity: 1; background: rgba(99, 102, 241, 0.15); border-radius: 4px; }
        .links-list { max-height: 300px; overflow-y: auto; }
        .link-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
        .link-item a { flex: 1; color: var(--cyan); text-decoration: none; font-size: 0.85rem; word-break: break-all; }
        .link-item a:hover { text-decoration: underline; }
        .link-title { font-weight: 600; display: block; }
        .link-url { font-size: 0.75rem; color: var(--text-muted); }
        .link-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; }
        .link-delete:hover { color: var(--danger); }
    
        /* Reordenar T√≥picos - Drag and Drop */
        .topic-drag-handle { cursor: grab; color: var(--text-muted); font-size: 1rem; padding: 0 4px; user-select: none; }
        .topic-drag-handle:hover { color: var(--accent); }
        .topic-item[draggable="true"]:active .topic-drag-handle { cursor: grabbing; }
        .topic-item.dragging { opacity: 0.4; background: var(--accent); }
        .topic-item.drag-over { border-top: 3px solid var(--accent); margin-top: -3px; }
        .topic-name { cursor: pointer; transition: color 0.2s; }
        .topic-name:hover { color: var(--accent); text-decoration: underline; }
    
        /* XP Legend */
        .xp-rules { display: flex; flex-direction: column; gap: 8px; }
        .xp-rule-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-primary); border-radius: 8px; }
        .xp-rule-icon { font-size: 1.1rem; }
        .xp-rule-text { flex: 1; font-size: 0.85rem; }
        .xp-rule-value { font-weight: 600; color: var(--accent); font-size: 0.85rem; }
        .xp-titles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
        .xp-title-item { font-size: 0.8rem; padding: 8px 10px; background: var(--bg-primary); border-radius: 6px; }
    
        /* Checkbox Revis√£o */
        .revisao-check { margin-top: 12px; padding: 10px; background: var(--bg-primary); border-radius: 8px; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.85rem; color: var(--text-sec); }
        .checkbox-label input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
    
        /* Quest√µes inline no registro */
        .questoes-inline { margin-top: 8px; padding: 10px; background: var(--bg-primary); border-radius: 8px; }
        .topic-acertos { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        .topic-acertos.good { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .topic-acertos.medium { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .topic-acertos.bad { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    
        /* A√ß√µes do hist√≥rico */
        .session-actions { display: flex; gap: 4px; }
        .historico-dia { margin-bottom: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .historico-dia-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-primary); cursor: pointer; transition: background 0.2s; }
        .historico-dia-header:hover { background: var(--bg-card); }
        .historico-dia-data { font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .historico-arrow { font-size: 0.7rem; transition: transform 0.2s; color: var(--text-muted); }
        .historico-dia.open .historico-arrow { transform: rotate(90deg); }
        .historico-dia-info { display: flex; align-items: center; gap: 12px; }
        .historico-dia-count { font-size: 0.8rem; color: var(--text-muted); }
        .historico-dia-total { font-weight: 700; color: var(--accent); font-size: 0.95rem; }
        .historico-dia-sessoes { display: none; padding: 8px; border-top: 1px solid var(--border); }
        .historico-dia.open .historico-dia-sessoes { display: block; }
        .historico-dia-sessoes .session-item { margin-bottom: 4px; }
        .historico-dia-sessoes .session-item:last-child { margin-bottom: 0; }
        .session-edit, .session-delete { background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .session-edit:hover { background: rgba(99, 102, 241, 0.15); }
        .session-delete:hover { background: rgba(239, 68, 68, 0.15); }
    
        /* Calend√°rio */
        .calendario-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .calendario-mes { font-size: 1.2rem; font-weight: 600; }
        .calendario-legenda { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; font-size: 0.8rem; color: var(--text-sec); }
        .leg-item { display: flex; align-items: center; gap: 6px; }
        .leg-cor { width: 12px; height: 12px; border-radius: 3px; }
        .calendario-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-header { text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); padding: 8px 0; }
        .cal-dia { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: var(--bg-primary); border: 1px solid var(--border); font-size: 0.85rem; }
        .cal-dia:hover { border-color: var(--accent); transform: scale(1.05); }
        .cal-dia.hoje { border: 2px solid var(--accent); font-weight: 700; }
        .cal-dia.futuro { opacity: 0.4; cursor: default; }
        .cal-dia.meta-ok { background: rgba(16, 185, 129, 0.25); border-color: var(--success); }
        .cal-dia.meta-parcial { background: rgba(245, 158, 11, 0.25); border-color: var(--warning); }
        .cal-dia.meta-nao { background: rgba(239, 68, 68, 0.15); border-color: var(--danger); }
        .cal-dia.outro-mes { opacity: 0.3; }
        .cal-dia-num { font-weight: 600; }
        .cal-dia-tempo { font-size: 0.65rem; color: var(--text-muted); }
        .cal-detalhe-item { padding: 10px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; }
        .cal-detalhe-disc { font-weight: 600; }
        .cal-detalhe-tempo { font-size: 0.85rem; color: var(--text-sec); }
    
        /* Login Firebase */
        .login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: var(--bg-primary); padding: 20px; }
        .login-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 40px; text-align: center; max-width: 400px; width: 100%; }
        .login-logo { font-size: 4rem; margin-bottom: 16px; }
        .login-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; color: var(--accent); }
        .login-subtitle { color: var(--text-muted); margin-bottom: 32px; }
        .btn-google { background: white; color: #333; border: none; padding: 14px 28px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .btn-google:hover { background: #f0f0f0; transform: scale(1.02); }
        .login-footer { margin-top: 32px; font-size: 0.8rem; color: var(--text-muted); }
        .app-wrapper { display: none; }
        .app-wrapper.active { display: flex; min-height: 100vh; }
        .user-box { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-card); border-radius: 8px; margin-bottom: 20px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .user-info-box { flex: 1; overflow: hidden; }
        .user-name-box { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sync-status { font-size: 0.7rem; color: var(--success); }
        .sync-status.syncing { color: var(--warning); }
        .sync-status.error { color: var(--danger); }
    
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed !important;
                left: -280px !important;
                width: 280px !important;
                z-index: 1000 !important;
                transition: left 0.3s ease !important;
                display: block !important;
                height: 100vh !important;
                overflow-y: auto !important;
                background: var(--bg-secondary) !important;
            }
            .sidebar.open { left: 0 !important; }
            .main { margin-left: 0; padding: 16px; padding-top: 70px; }
            .mobile-header {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                align-items: center;
                padding: 0 16px;
                z-index: 999;
            }
            .menu-toggle {
                background: none;
                border: none;
                color: var(--text);
                font-size: 1.5rem;
                cursor: pointer;
                padding: 8px;
            }
            .mobile-title {
                flex: 1;
                text-align: center;
                font-weight: 700;
                color: var(--accent);
            }
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            .mobile-overlay.open { display: block; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .grid-2 { grid-template-columns: 1fr; }
            .stat-value { font-size: 1.4rem; }
            .page-title { font-size: 1.3rem; }
            .login-card { padding: 24px; }
            .login-logo { font-size: 3rem; }
            .login-title { font-size: 1.5rem; }
        }
        @media (min-width: 769px) {
            .mobile-header { display: none; }
            .mobile-overlay { display: none !important; }
        }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- TELA DE LOGIN -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-logo">üìö</div>
            <h1 class="login-title">EstudosPRO</h1>
            <p class="login-subtitle">Organize seus estudos para o TJPR 2025</p>
            <button class="btn-google" onclick="loginComGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Entrar com Google
            </button>
            <p class="login-footer">‚òÅÔ∏è Seus dados sincronizam automaticamente entre dispositivos</p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div class="app" id="appWrapper" style="display:none;">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
            <div class="mobile-title">üìö EstudosPRO</div>
            <div style="width:40px;"></div>
        </div>
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>
    <nav class="sidebar">
        <div class="logo">üìö EstudosPRO</div>
        <div class="logo-sub">TJPR 2025</div>
        <div class="user-box" id="userBox">
            <img class="user-avatar" id="userAvatar" src="" alt="">
            <div class="user-info-box">
                <div class="user-name-box" id="userName">Usu√°rio</div>
                <div class="sync-status" id="syncStatus">‚òÅÔ∏è Sincronizado</div>
            </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
            <span id="themeIcon">üåô</span>
        </button>
        <div class="nav-section">Principal</div>
        <div class="nav-item active" data-page="dashboard">üè† Dashboard</div>
        <div class="nav-item" data-page="registro">üìù Registro</div>
        <div class="nav-item" data-page="revisoes">üîÑ Revis√µes <span class="nav-badge" id="navRevisoes">0</span></div>
        <div class="nav-section">Organiza√ß√£o</div>
        <div class="nav-item" data-page="disciplinas">üìö Disciplinas</div>
        <div class="nav-item" data-page="ciclos">üîÅ Ciclos</div>
        <div class="nav-item" data-page="metas">üéØ Metas</div>
        <div class="nav-section">Desempenho</div>
        <div class="nav-item" data-page="questoes">‚ùì Quest√µes</div>
        <div class="nav-item" data-page="stats">üìä Estat√≠sticas</div>
        <div class="nav-item" data-page="calendario">üìÖ Calend√°rio</div>
        <div class="nav-section">Sistema</div>
        <div class="nav-item" data-page="config">‚öôÔ∏è Configura√ß√µes</div>
    </nav>
    <main class="main">
        <!-- DASHBOARD -->
        <div class="page active" id="page-dashboard">
            <h1 class="page-title">Dashboard</h1>
            <p class="page-sub">Vis√£o geral do seu progresso</p>
            <div class="stats-grid">
                <div class="stat-card purple"><div class="stat-label">Horas (Semana)</div><div class="stat-value" id="statHoras">0h</div><div class="stat-sub">Meta: <span id="statMetaHoras">49</span>h</div></div>
                <div class="stat-card green"><div class="stat-label">T√≥picos Dominados</div><div class="stat-value" id="statTopicos">0</div><div class="stat-sub">de <span id="statTotalTopicos">0</span></div></div>
                <div class="stat-card orange"><div class="stat-label">Revis√µes Pendentes</div><div class="stat-value" id="statRevisoes">0</div><div class="stat-sub"><span id="statRevisoesHoje">0</span> para hoje</div></div>
                <div class="stat-card blue"><div class="stat-label">% Acertos</div><div class="stat-value" id="statAcertos">0%</div><div class="stat-sub"><span id="statTotalQuestoes">0</span> quest√µes</div></div>
            </div>
            <div class="streak-xp-bar">
                <div class="streak-card">
                    <div class="streak-icon">üî•</div>
                    <div class="streak-info">
                        <div class="streak-value" id="streakDias">0</div>
                        <div class="streak-label">dias seguidos</div>
                    </div>
                </div>
                <div class="xp-card">
                    <div class="xp-header">
                        <span class="xp-level" id="xpLevel">N√≠vel 1</span>
                        <span class="xp-title" id="xpTitle">Iniciante</span>
                    </div>
                    <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width:0%"></div></div>
                    <div class="xp-text"><span id="xpCurrent">0</span> / <span id="xpNext">100</span> XP</div>
                </div>
                <div class="badges-card">
                    <div class="badges-title">üèÜ Conquistas</div>
                    <div class="badges-list" id="badgesList"></div>
                </div>
            </div>
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><div class="card-title">üéØ Meta Semanal</div></div>
                    <div class="progress-header"><span>Progresso</span><span id="metaPct">0%</span></div>
                    <div class="progress-bar"><div class="progress-fill" id="metaBar" style="width:0%"></div></div>
                    <div style="margin-top:16px">
                        <div class="goal-item"><div class="goal-icon hours">‚è±Ô∏è</div><div class="goal-info"><div class="goal-name">Horas</div><div class="goal-progress" id="goalHorasText">0/49h</div></div><div class="goal-pct" id="goalHorasPct">0%</div></div>
                        <div class="goal-item"><div class="goal-icon topics">üìñ</div><div class="goal-info"><div class="goal-name">T√≥picos</div><div class="goal-progress" id="goalTopicosText">0/10</div></div><div class="goal-pct" id="goalTopicosPct">0%</div></div>
                        <div class="goal-item"><div class="goal-icon questions">‚ùì</div><div class="goal-info"><div class="goal-name">Quest√µes</div><div class="goal-progress" id="goalQuestoesText">0/100</div></div><div class="goal-pct" id="goalQuestoesPct">0%</div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title">üîÑ Revis√µes Hoje</div><button class="btn btn-sm btn-secondary" onclick="navTo('revisoes')">Ver todas</button></div>
                    <div id="revisoesHoje"><div class="empty"><div class="empty-icon">‚ú®</div><div>Nenhuma revis√£o hoje!</div></div></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><div class="card-title">üìà Progresso por Disciplina</div></div><div id="disciplinasProgress"><div class="empty"><div class="empty-icon">üìö</div><div>Cadastre disciplinas</div></div></div></div>
        </div>

        <!-- REGISTRO -->
        <div class="page" id="page-registro">
            <h1 class="page-title">Registro de Estudos</h1>
            <p class="page-sub">Registre suas sess√µes</p>
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚è±Ô∏è Timer</div>
                        <div class="pomodoro-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" id="pomodoroMode" onchange="togglePomodoro()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="font-size:0.8rem;color:var(--text-sec);">üçÖ Pomodoro</span>
                        </div>
                    </div>
                    <div id="pomodoroStatus" style="display:none;text-align:center;margin-bottom:12px;">
                        <span class="pomodoro-badge" id="pomodoroBadge">üçÖ Foco</span>
                        <span style="font-size:0.8rem;color:var(--text-muted);margin-left:8px;">Ciclo <span id="pomodoroCiclo">1</span>/4</span>
                    </div>
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    <div class="form-group"><label class="form-label">Disciplina *</label><select class="form-select" id="timerDisciplina" onchange="updateTimerTopicos()"><option value="">Selecione</option></select></div>
                    <div class="form-group"><label class="form-label">T√≥pico</label><select class="form-select" id="timerTopico"><option value="">Geral</option></select></div>
                    <div class="timer-controls">
                        <button class="btn btn-primary" id="btnStart" onclick="timerStart()">‚ñ∂Ô∏è Iniciar</button>
                        <button class="btn btn-secondary" id="btnPause" onclick="timerPause()" disabled>‚è∏Ô∏è Pausar</button>
                        <button class="btn btn-danger" id="btnReset" onclick="timerReset()" disabled>üîÑ</button>
                        <button class="btn btn-success" id="btnSave" onclick="timerSave()" disabled>üíæ</button>
                    </div>
                    <div class="revisao-check">
                        <label class="checkbox-label">
                            <input type="checkbox" id="timerGerarRevisao" checked>
                            <span>üîÑ Gerar revis√µes espa√ßadas</span>
                        </label>
                    </div>
                    <div class="questoes-inline">
                        <label class="checkbox-label" style="margin-bottom:8px;">
                            <input type="checkbox" id="timerComQuestoes" onchange="toggleQuestoesTimer()">
                            <span>‚ùì Registrar quest√µes junto</span>
                        </label>
                        <div id="timerQuestoesFields" style="display:none;">
                            <div style="display:flex;gap:8px;">
                                <input type="number" class="form-input" id="timerQuestoesTotal" placeholder="Total" min="1" style="flex:1;">
                                <input type="number" class="form-input" id="timerQuestoesAcertos" placeholder="Acertos" min="0" style="flex:1;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title">‚úèÔ∏è Manual</div></div>
                    <div class="form-group"><label class="form-label">Data *</label><input type="date" class="form-input" id="manualData"></div>
                    <div class="form-group"><label class="form-label">Disciplina *</label><select class="form-select" id="manualDisciplina" onchange="updateManualTopicos()"><option value="">Selecione</option></select></div>
                    <div class="form-group"><label class="form-label">T√≥pico</label><select class="form-select" id="manualTopico"><option value="">Geral</option></select></div>
                    <div class="form-group"><label class="form-label">Minutos *</label><input type="number" class="form-input" id="manualTempo" placeholder="60" min="1"></div>
                    <div class="revisao-check" style="margin-bottom:8px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="manualGerarRevisao" checked>
                            <span>üîÑ Gerar revis√µes espa√ßadas</span>
                        </label>
                    </div>
                    <div class="questoes-inline" style="margin-bottom:12px;">
                        <label class="checkbox-label" style="margin-bottom:8px;">
                            <input type="checkbox" id="manualComQuestoes" onchange="toggleQuestoesManual()">
                            <span>‚ùì Registrar quest√µes junto</span>
                        </label>
                        <div id="manualQuestoesFields" style="display:none;">
                            <div style="display:flex;gap:8px;">
                                <input type="number" class="form-input" id="manualQuestoesTotal" placeholder="Total" min="1" style="flex:1;">
                                <input type="number" class="form-input" id="manualQuestoesAcertos" placeholder="Acertos" min="0" style="flex:1;">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="manualSave()" style="width:100%">üíæ Registrar</button>
                </div>
            </div>
            <div class="card"><div class="card-header"><div class="card-title">üìã Hist√≥rico</div><span style="font-size:0.8rem;color:var(--text-muted)" id="historicoCount">0</span></div><div id="historicoSessoes"><div class="empty"><div class="empty-icon">üìù</div><div>Nenhuma sess√£o</div></div></div></div>
        </div>

        <!-- DISCIPLINAS -->
        <div class="page" id="page-disciplinas">
            <h1 class="page-title">Disciplinas</h1>
            <p class="page-sub">Gerencie disciplinas e t√≥picos do edital</p>
            <div style="margin-bottom:20px;display:flex;gap:12px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="openModal('modalDisc')">+ Nova Disciplina</button>
                <button class="btn btn-secondary" onclick="abrirImportarTopicos()">üìã Importar T√≥picos</button>
            </div>
            <div id="listaDisciplinas"><div class="empty"><div class="empty-icon">üìö</div><div>Nenhuma disciplina cadastrada.</div></div></div>
        </div>

        <!-- REVIS√ïES -->
        <div class="page" id="page-revisoes">
            <h1 class="page-title">Revis√µes</h1>
            <p class="page-sub">Gerencie suas revis√µes espa√ßadas</p>
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card orange"><div class="stat-label">Pendentes</div><div class="stat-value" id="revPendentes">0</div></div>
                <div class="stat-card purple"><div class="stat-label">Atrasadas</div><div class="stat-value" id="revAtrasadas">0</div></div>
                <div class="stat-card green"><div class="stat-label">Conclu√≠das</div><div class="stat-value" id="revConcluidas">0</div></div>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="hoje" onclick="switchRevTab('hoje')">üìÖ Hoje <span class="tab-count" id="tabHojeCount">0</span></div>
                <div class="tab" data-tab="pendentes" onclick="switchRevTab('pendentes')">‚è≥ Pendentes <span class="tab-count" id="tabPendCount">0</span></div>
                <div class="tab" data-tab="atrasadas" onclick="switchRevTab('atrasadas')">‚ö†Ô∏è Atrasadas <span class="tab-count" id="tabAtrasadasCount">0</span></div>
                <div class="tab" data-tab="concluidas" onclick="switchRevTab('concluidas')">‚úÖ Conclu√≠das</div>
            </div>
            <div class="card"><div id="revContent"></div></div>
        </div>

        <!-- OUTRAS P√ÅGINAS -->
        <div class="page" id="page-ciclos">
            <h1 class="page-title">Ciclos de Estudo</h1>
            <p class="page-sub">Gere ciclos proporcionais ao peso e tempo dispon√≠vel</p>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><div class="card-title">‚öôÔ∏è Configura√ß√£o do Ciclo</div></div>
                    
                    <div class="form-group">
                        <label class="form-label">Horas Semanais Dispon√≠veis</label>
                        <input type="number" class="form-input" id="cicloHorasSemana" value="49" min="1" max="100">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Total de Passos no Ciclo</label>
                        <input type="number" class="form-input" id="cicloPassos" value="32" min="1" max="200">
                        <small style="color:var(--text-muted);font-size:0.75rem;margin-top:4px;display:block;">Cada passo ter√° dura√ß√£o proporcional ao peso</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Disciplinas no Ciclo</label>
                        <div id="cicloDiscList" style="max-height:250px;overflow-y:auto;background:var(--bg-primary);border-radius:8px;padding:12px;">
                            <div class="empty"><div class="empty-icon">üìö</div><div>Cadastre disciplinas primeiro</div></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="gerarCiclo()" style="width:100%">üîÑ Gerar Ciclo</button>
                </div>
                
                <div class="card">
                    <div class="card-header"><div class="card-title">üìä Distribui√ß√£o</div></div>
                    <div id="cicloChart" style="display:flex;justify-content:center;align-items:center;min-height:200px;">
                        <div class="empty"><div class="empty-icon">ü•ß</div><div>Gere um ciclo para ver o gr√°fico</div></div>
                    </div>
                    <div id="cicloLegenda" style="margin-top:16px;"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã Ciclo Gerado</div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span id="cicloResumo" style="font-size:0.8rem;color:var(--text-muted);"></span>
                        <button class="btn btn-sm btn-secondary" onclick="resetarProgressoCiclo()" id="btnResetCiclo" style="display:none;">üîÑ Resetar</button>
                        <button class="btn btn-sm btn-secondary" onclick="copiarCiclo()" id="btnCopiarCiclo" style="display:none;">üìã Copiar</button>
                    </div>
                </div>
                <div id="cicloResultado">
                    <div class="empty"><div class="empty-icon">üîÅ</div><div>Configure e gere seu ciclo de estudos</div></div>
                </div>
            </div>
        </div>
        <div class="page" id="page-metas">
            <h1 class="page-title">Metas</h1>
            <p class="page-sub">Configure suas metas semanais de estudo</p>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><div class="card-title">üéØ Metas Semanais</div></div>
                    <div class="form-group">
                        <label class="form-label">‚è±Ô∏è Horas de Estudo por Semana</label>
                        <input type="number" class="form-input" id="metaHoras" min="1" max="100" placeholder="49">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìñ T√≥picos a Dominar por Semana</label>
                        <input type="number" class="form-input" id="metaTopicos" min="1" max="100" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‚ùì Quest√µes por Semana</label>
                        <input type="number" class="form-input" id="metaQuestoes" min="1" max="1000" placeholder="100">
                    </div>
                    <button class="btn btn-primary" onclick="salvarMetas()" style="width:100%">üíæ Salvar Metas</button>
                </div>
                
                <div class="card">
                    <div class="card-header"><div class="card-title">üìÖ Contagem Regressiva</div></div>
                    <div class="form-group">
                        <label class="form-label">Data da Prova</label>
                        <input type="date" class="form-input" id="metaDataProva">
                    </div>
                    <button class="btn btn-secondary" onclick="salvarDataProva()" style="width:100%;margin-bottom:16px;">üíæ Salvar Data</button>
                    <div id="contagemRegressiva" style="text-align:center;padding:20px;background:var(--bg-primary);border-radius:12px;">
                        <div style="font-size:2.5rem;font-weight:700;color:var(--accent);" id="diasRestantes">--</div>
                        <div style="font-size:0.9rem;color:var(--text-sec);">dias restantes</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><div class="card-title">üìä Progresso Atual da Semana</div></div>
                <div id="metasProgresso"></div>
            </div>
        </div>
        <div class="page" id="page-questoes">
            <h1 class="page-title">Quest√µes</h1>
            <p class="page-sub">Registre e acompanhe seu desempenho em quest√µes</p>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><div class="card-title">üìù Registrar Quest√µes</div></div>
                    <div class="form-group">
                        <label class="form-label">Data *</label>
                        <input type="date" class="form-input" id="questaoData">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Disciplina *</label>
                        <select class="form-select" id="questaoDisciplina">
                            <option value="">Selecione</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fonte</label>
                        <input type="text" class="form-input" id="questaoFonte" placeholder="Ex: FGV 2023, VUNESP, Qconcursos">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div class="form-group">
                            <label class="form-label">Total *</label>
                            <input type="number" class="form-input" id="questaoTotal" min="1" placeholder="20">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Acertos *</label>
                            <input type="number" class="form-input" id="questaoAcertos" min="0" placeholder="15">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="registrarQuestao()" style="width:100%">üíæ Registrar</button>
                </div>
                
                <div class="card">
                    <div class="card-header"><div class="card-title">üìä Desempenho Geral</div></div>
                    <div id="questaoStats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                        <div style="background:var(--bg-primary);padding:16px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.5rem;font-weight:700;color:var(--accent);" id="qTotalRespondidas">0</div>
                            <div style="font-size:0.75rem;color:var(--text-muted);">Respondidas</div>
                        </div>
                        <div style="background:var(--bg-primary);padding:16px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.5rem;font-weight:700;color:var(--success);" id="qTotalAcertos">0</div>
                            <div style="font-size:0.75rem;color:var(--text-muted);">Acertos</div>
                        </div>
                        <div style="background:var(--bg-primary);padding:16px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.5rem;font-weight:700;color:var(--cyan);" id="qTaxaGeral">0%</div>
                            <div style="font-size:0.75rem;color:var(--text-muted);">Taxa Geral</div>
                        </div>
                    </div>
                    <div class="card-header" style="margin-bottom:12px;padding:0;"><div class="card-title" style="font-size:0.85rem;">üìà Por Disciplina</div></div>
                    <div id="questaoPorDisciplina">
                        <div class="empty"><div class="empty-icon">üìä</div><div>Registre quest√µes para ver estat√≠sticas</div></div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã Hist√≥rico</div>
                    <span style="font-size:0.8rem;color:var(--text-muted);" id="questaoHistCount">0 registros</span>
                </div>
                <div id="questaoHistorico">
                    <div class="empty"><div class="empty-icon">üìù</div><div>Nenhum registro ainda</div></div>
                </div>
            </div>
        </div>
        <div class="page" id="page-stats">
            <h1 class="page-title">Estat√≠sticas</h1>
            <p class="page-sub">Vis√£o detalhada do seu progresso</p>
            
            <div class="stats-grid">
                <div class="stat-card purple">
                    <div class="stat-label">Horas Totais</div>
                    <div class="stat-value" id="statTotalHoras">0h</div>
                    <div class="stat-sub">desde o in√≠cio</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Sess√µes de Estudo</div>
                    <div class="stat-value" id="statTotalSessoes">0</div>
                    <div class="stat-sub">registradas</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">M√©dia Di√°ria</div>
                    <div class="stat-value" id="statMediaDiaria">0h</div>
                    <div class="stat-sub">√∫ltimos 7 dias</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Dias Estudados</div>
                    <div class="stat-value" id="statDiasEstudados">0</div>
                    <div class="stat-sub">dias √∫nicos</div>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><div class="card-title">üìö Tempo por Disciplina</div></div>
                    <div id="statsPorDisciplina">
                        <div class="empty"><div class="empty-icon">üìä</div><div>Registre sess√µes para ver estat√≠sticas</div></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><div class="card-title">üìà √öltimos 7 Dias</div></div>
                    <div id="statsUltimos7Dias" style="display:flex;align-items:flex-end;justify-content:space-between;height:150px;padding:10px 0;">
                        <div class="empty" style="width:100%;"><div class="empty-icon">üìà</div><div>Sem dados ainda</div></div>
                    </div>
                    <div id="statsUltimos7DiasLabels" style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-muted);margin-top:8px;"></div>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><div class="card-title">üìñ Status dos T√≥picos</div></div>
                    <div id="statsTopicosStatus"></div>
                </div>
                
                <div class="card">
                    <div class="card-header"><div class="card-title">üîÑ Revis√µes</div></div>
                    <div id="statsRevisoes"></div>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><div class="card-title">üìä Comparativo Semanal</div></div>
                    <div id="statsComparativo"></div>
                </div>
                
                <div class="card">
                    <div class="card-header"><div class="card-title">üéØ Previs√£o de Conclus√£o</div></div>
                    <div id="statsPrevisao"></div>
                </div>
            </div>
        </div>
        
        <div class="page" id="page-calendario">
            <div class="page-header">
                <h1 class="page-title">üìÖ Calend√°rio de Estudos</h1>
            </div>
            <div class="card">
                <div class="calendario-nav">
                    <button class="btn btn-secondary btn-sm" onclick="mesAnterior()">‚óÄ Anterior</button>
                    <span class="calendario-mes" id="calendarioMesAno">Janeiro 2026</span>
                    <button class="btn btn-secondary btn-sm" onclick="mesProximo()">Pr√≥ximo ‚ñ∂</button>
                </div>
                <div class="calendario-legenda">
                    <span class="leg-item"><span class="leg-cor" style="background:var(--success)"></span> Meta batida</span>
                    <span class="leg-item"><span class="leg-cor" style="background:var(--warning)"></span> Estudou parcial</span>
                    <span class="leg-item"><span class="leg-cor" style="background:var(--danger)"></span> N√£o estudou</span>
                    <span class="leg-item"><span class="leg-cor" style="background:var(--bg-primary)"></span> Futuro</span>
                    <span class="leg-item" style="margin-left:auto;font-weight:600;color:var(--accent);" id="calendarioMetaDiaria">Meta: 7h/dia</span>
                </div>
                <div class="calendario-grid" id="calendarioGrid"></div>
            </div>
            <div class="card" id="calendarioDiaDetalhe" style="display:none;">
                <div class="card-header"><div class="card-title" id="calendarioDiaTitulo">Detalhes do Dia</div></div>
                <div id="calendarioDiaConteudo"></div>
            </div>
        </div>
        
        <div class="page" id="page-config">
            <h1 class="page-title">Configura√ß√µes</h1>
            <p class="page-sub">Gerencie seus dados e prefer√™ncias</p>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><div class="card-title">üíæ Backup e Restaura√ß√£o</div></div>
                    <p style="font-size:0.85rem;color:var(--text-sec);margin-bottom:16px;">Exporte seus dados para um arquivo JSON ou restaure de um backup anterior.</p>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="exportarDados()">üì• Exportar Dados</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Importar Dados</button>
                        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarDados(event)">
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><div class="card-title">üîÑ Intervalos de Revis√£o</div></div>
                    <p style="font-size:0.85rem;color:var(--text-sec);margin-bottom:16px;">Defina os intervalos (em dias) para as revis√µes espa√ßadas.</p>
                    <div class="form-group">
                        <input type="text" class="form-input" id="configIntervalos" placeholder="1, 3, 7, 14, 30">
                        <small style="color:var(--text-muted);font-size:0.75rem;margin-top:4px;display:block;">Separe os valores por v√≠rgula</small>
                    </div>
                    <button class="btn btn-primary" onclick="salvarIntervalos()">Salvar Intervalos</button>
                </div>
            </div>
            
            <div class="card" style="border-color:var(--danger);">
                <div class="card-header"><div class="card-title" style="color:var(--danger);">‚ö†Ô∏è Zona de Perigo</div></div>
                <p style="font-size:0.85rem;color:var(--text-sec);margin-bottom:16px;">A√ß√µes irrevers√≠veis. Tenha certeza antes de continuar.</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-danger" onclick="limparTodosDados()">üóëÔ∏è Limpar Todos os Dados</button>
                    <button class="btn btn-secondary" onclick="limparSessoes()">üßπ Limpar Sess√µes e Revis√µes</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><div class="card-title">üìä Estat√≠sticas do Banco</div></div>
                <div id="configStats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;"></div>
            </div>
            
            <div class="card">
                <div class="card-header"><div class="card-title">‚≠ê Sistema de XP e N√≠veis</div></div>
                <p style="font-size:0.85rem;color:var(--text-sec);margin-bottom:16px;">Ganhe XP realizando atividades de estudo. S√£o 1000 n√≠veis com progress√£o exponencial (mais f√°cil no in√≠cio).</p>
                
                <div style="margin-bottom:16px;">
                    <div class="form-label" style="margin-bottom:8px;">üìà Como ganhar XP:</div>
                    <div class="xp-rules">
                        <div class="xp-rule-item"><span class="xp-rule-icon">‚è±Ô∏è</span><span class="xp-rule-text">Horas de estudo</span><span class="xp-rule-value">+10 XP/hora</span></div>
                        <div class="xp-rule-item"><span class="xp-rule-icon">üìñ</span><span class="xp-rule-text">T√≥pico dominado</span><span class="xp-rule-value">+20 XP</span></div>
                        <div class="xp-rule-item"><span class="xp-rule-icon">‚ùì</span><span class="xp-rule-text">Quest√£o resolvida</span><span class="xp-rule-value">+1 XP</span></div>
                        <div class="xp-rule-item"><span class="xp-rule-icon">üîÑ</span><span class="xp-rule-text">Revis√£o conclu√≠da</span><span class="xp-rule-value">+5 XP</span></div>
                        <div class="xp-rule-item"><span class="xp-rule-icon">üèÜ</span><span class="xp-rule-text">Conquista desbloqueada</span><span class="xp-rule-value">+50 XP</span></div>
                    </div>
                </div>
                
                <div>
                    <div class="form-label" style="margin-bottom:8px;">üéñÔ∏è T√≠tulos por N√≠vel:</div>
                    <div class="xp-titles-grid">
                        <div class="xp-title-item">ü•í <b>1-10:</b> Noob</div>
                        <div class="xp-title-item">üê£ <b>11-25:</b> Calouro</div>
                        <div class="xp-title-item">üìó <b>26-50:</b> Aprendiz</div>
                        <div class="xp-title-item">üìò <b>51-75:</b> Estudante</div>
                        <div class="xp-title-item">üìô <b>76-100:</b> Dedicado</div>
                        <div class="xp-title-item">üí™ <b>101-150:</b> Aplicado</div>
                        <div class="xp-title-item">üéØ <b>151-200:</b> Focado</div>
                        <div class="xp-title-item">üî• <b>201-275:</b> Esfor√ßado</div>
                        <div class="xp-title-item">‚öîÔ∏è <b>276-350:</b> Guerreiro</div>
                        <div class="xp-title-item">üõ°Ô∏è <b>351-425:</b> Veterano</div>
                        <div class="xp-title-item">üß† <b>426-500:</b> Expert</div>
                        <div class="xp-title-item">üöÄ <b>501-600:</b> Avan√ßado</div>
                        <div class="xp-title-item">üéì <b>601-700:</b> Mestre</div>
                        <div class="xp-title-item">üëë <b>701-800:</b> Gr√£o-Mestre</div>
                        <div class="xp-title-item">üßô <b>801-900:</b> S√°bio</div>
                        <div class="xp-title-item">‚≠ê <b>901-950:</b> Lend√°rio</div>
                        <div class="xp-title-item">üåü <b>951-999:</b> M√≠tico</div>
                        <div class="xp-title-item">‚öñÔ∏è <b>1000:</b> JUIZ APROVADO</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
</div><!-- fim app-wrapper -->
    <div class="toast-container" id="toastContainer"></div>

<!-- Modais -->
<div class="modal-backdrop" id="modalDisc">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">Nova Disciplina</div><button class="modal-close" onclick="closeModal('modalDisc')">√ó</button></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" id="discNome" placeholder="Ex: Direito Constitucional"></div>
            <div class="form-group"><label class="form-label">N√≠vel de Conhecimento</label><select class="form-select" id="discPeso"><option value="1">üü¢ Domino bem (peso 1)</option><option value="2">üîµ Sei razo√°vel (peso 2)</option><option value="3" selected>üü° Conhecimento m√©dio (peso 3)</option><option value="4">üü† Sei pouco (peso 4)</option><option value="5">üî¥ N√£o sei nada (peso 5)</option></select></div>
            <div class="form-group"><label class="form-label">T√≥picos (um por linha)</label><textarea class="form-textarea" id="discTopicos" placeholder="Teoria da Constitui√ß√£o&#10;Poder Constituinte"></textarea></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalDisc')">Cancelar</button><button class="btn btn-primary" onclick="salvarDisciplina()">Salvar</button></div>
    </div>
</div>
<div class="modal-backdrop" id="modalEditDisc">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">Editar Disciplina</div><button class="modal-close" onclick="closeModal('modalEditDisc')">√ó</button></div>
        <div class="modal-body">
            <input type="hidden" id="editDiscId">
            <div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" id="editDiscNome"></div>
            <div class="form-group"><label class="form-label">N√≠vel de Conhecimento</label><select class="form-select" id="editDiscPeso"><option value="1">üü¢ Domino bem (peso 1)</option><option value="2">üîµ Sei razo√°vel (peso 2)</option><option value="3">üü° Conhecimento m√©dio (peso 3)</option><option value="4">üü† Sei pouco (peso 4)</option><option value="5">üî¥ N√£o sei nada (peso 5)</option></select></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalEditDisc')">Cancelar</button><button class="btn btn-primary" onclick="atualizarDisciplina()">Salvar</button></div>
    </div>
</div>
<div class="modal-backdrop" id="modalEditSessao">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">‚úèÔ∏è Editar Sess√£o</div><button class="modal-close" onclick="closeModal('modalEditSessao')">√ó</button></div>
        <div class="modal-body">
            <input type="hidden" id="editSessaoId">
            <div class="form-group">
                <label class="form-label">Data *</label>
                <input type="date" class="form-input" id="editSessaoData">
            </div>
            <div class="form-group">
                <label class="form-label">Disciplina *</label>
                <select class="form-select" id="editSessaoDisciplina" onchange="updateEditSessaoTopicos()">
                    <option value="">Selecione</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">T√≥pico</label>
                <select class="form-select" id="editSessaoTopico">
                    <option value="">Geral</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Minutos *</label>
                <input type="number" class="form-input" id="editSessaoMinutos" min="1">
            </div>
            <div class="form-group" id="editSessaoQuestoesGroup" style="display:none;">
                <label class="form-label">Quest√µes vinculadas</label>
                <div style="display:flex;gap:8px;">
                    <input type="number" class="form-input" id="editSessaoQuestoesTotal" placeholder="Total" min="0" style="flex:1;">
                    <input type="number" class="form-input" id="editSessaoQuestoesAcertos" placeholder="Acertos" min="0" style="flex:1;">
                </div>
                <small style="color:var(--text-muted);">Deixe em branco para n√£o alterar</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('modalEditSessao')">Cancelar</button>
            <button class="btn btn-primary" onclick="salvarEdicaoSessao()">Salvar</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="modalImportTopicos">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">üìã Importar T√≥picos em Lote</div><button class="modal-close" onclick="closeModal('modalImportTopicos')">√ó</button></div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Disciplina *</label>
                <select class="form-select" id="importTopicosDisc">
                    <option value="">Selecione a disciplina</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Lista de T√≥picos (um por linha)</label>
                <textarea class="form-textarea" id="importTopicosLista" placeholder="Cole aqui os t√≥picos, um por linha:

Pessoas Naturais
Pessoas Jur√≠dicas
Domic√≠lio
Bens
Fatos Jur√≠dicos
Neg√≥cio Jur√≠dico
Prescri√ß√£o e Decad√™ncia" style="min-height:200px;font-family:monospace;font-size:0.9rem;"></textarea>
            </div>
            <small style="color:var(--text-muted);">üí° Copie do edital ou √≠ndice do material de estudo</small>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('modalImportTopicos')">Cancelar</button>
            <button class="btn btn-primary" onclick="importarTopicosLote()">Importar</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="modalEditTopico">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">‚úèÔ∏è Editar T√≥pico</div><button class="modal-close" onclick="closeModal('modalEditTopico')">√ó</button></div>
        <div class="modal-body">
            <input type="hidden" id="editTopicoDiscId">
            <input type="hidden" id="editTopicoId">
            <div class="form-group">
                <label class="form-label">Nome do T√≥pico</label>
                <textarea class="form-textarea" id="editTopicoNome" placeholder="Nome do t√≥pico..." style="min-height:120px;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('modalEditTopico')">Cancelar</button>
            <button class="btn btn-primary" onclick="salvarEdicaoTopico()">Salvar</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="modalAnotacao">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">üìù Anota√ß√£o</div><button class="modal-close" onclick="closeModal('modalAnotacao')">√ó</button></div>
        <div class="modal-body">
            <input type="hidden" id="anotacaoDiscId">
            <input type="hidden" id="anotacaoTopId">
            <div class="form-group">
                <label class="form-label" id="anotacaoTopicoNome">T√≥pico</label>
                <textarea class="form-textarea" id="anotacaoTexto" placeholder="Escreva suas anota√ß√µes, resumos, pontos importantes..." style="min-height:200px;"></textarea>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalAnotacao')">Cancelar</button><button class="btn btn-primary" onclick="salvarAnotacao()">Salvar</button></div>
    </div>
</div>

<div class="modal-backdrop" id="modalLinks">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">üîó Links √öteis</div><button class="modal-close" onclick="closeModal('modalLinks')">√ó</button></div>
        <div class="modal-body">
            <input type="hidden" id="linksDiscId">
            <div class="form-group">
                <label class="form-label">Adicionar Link</label>
                <input type="text" class="form-input" id="linkTitulo" placeholder="T√≠tulo (ex: Aula de Constitucional)" style="margin-bottom:8px;">
                <input type="text" class="form-input" id="linkUrl" placeholder="URL (ex: https://...)">
            </div>
            <button class="btn btn-primary btn-sm" onclick="adicionarLink()" style="margin-bottom:16px;">+ Adicionar</button>
            <div class="form-label">Links Salvos</div>
            <div class="links-list" id="linksList"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalLinks')">Fechar</button></div>
    </div>
</div>

<div class="modal-backdrop" id="modalAddTopic">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">Adicionar T√≥pico</div><button class="modal-close" onclick="closeModal('modalAddTopic')">√ó</button></div>
        <div class="modal-body">
            <input type="hidden" id="addTopicDiscId">
            <div class="form-group"><label class="form-label">Nome do T√≥pico *</label><input type="text" class="form-input" id="addTopicNome"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalAddTopic')">Cancelar</button><button class="btn btn-primary" onclick="salvarNovoTopico()">Adicionar</button></div>
    </div>
</div>

<script>
// ==================== FIREBASE ====================
const firebaseConfig = {
    apiKey: "AIzaSyB6v2dwNZT7M_n1KbGv5RTCEjULHyd3ic0",
    authDomain: "estudospro-a7c45.firebaseapp.com",
    projectId: "estudospro-a7c45",
    storageBucket: "estudospro-a7c45.firebasestorage.app",
    messagingSenderId: "438581063457",
    appId: "1:438581063457:web:c7828f723d9256be241860"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let syncTimeout = null;

// Login com Google
function loginComGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
        .then((result) => {
            console.log('Login OK:', result.user.email);
        })
        .catch((error) => {
            console.error('Erro login:', error);
            showToast('Erro ao fazer login: ' + error.message, 'error');
        });
}

// Logout
function logout() {
    if(confirm('Sair da conta? Seus dados continuam salvos na nuvem.')) {
        auth.signOut();
    }
}

// Observer de autentica√ß√£o
auth.onAuthStateChanged((user) => {
    if(user) {
        currentUser = user;
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appWrapper').style.display = 'flex';
        document.getElementById('userAvatar').src = user.photoURL || '';
        document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
        document.getElementById('userEmail').textContent = user.email;
        
        // Carregar dados da nuvem
        carregarDaNuvem();
    } else {
        currentUser = null;
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('appWrapper').style.display = 'none';
    }
});

// Carregar dados do Firestore
async function carregarDaNuvem() {
    if(!currentUser) return;
    
    setSyncStatus('syncing', 'üîÑ Carregando...');
    
    try {
        const doc = await db.collection('usuarios').doc(currentUser.uid).get();
        
        if(doc.exists) {
            const dados = doc.data();
            if(dados.state) {
                state = { ...defaultState, ...dados.state };
                console.log('Dados carregados da nuvem');
            }
        } else {
            // Primeiro acesso - verificar dados locais
            const local = localStorage.getItem(STORAGE_KEY);
            if(local) {
                try {
                    state = { ...defaultState, ...JSON.parse(local) };
                    await salvarNaNuvem();
                    console.log('Dados locais migrados para nuvem');
                } catch(e) {
                    state = { ...defaultState };
                }
            }
        }
        
        // Atualizar interface
        refreshAll();
        setSyncStatus('synced', '‚òÅÔ∏è Sincronizado');
        
    } catch(error) {
        console.error('Erro ao carregar:', error);
        setSyncStatus('error', '‚ùå Erro');
        
        // Fallback local
        const local = localStorage.getItem(STORAGE_KEY);
        if(local) {
            try {
                state = { ...defaultState, ...JSON.parse(local) };
                refreshAll();
            } catch(e) {}
        }
    }
}

// Salvar no Firestore
async function salvarNaNuvem() {
    if(!currentUser) return;
    
    setSyncStatus('syncing', 'üîÑ Salvando...');
    
    try {
        await db.collection('usuarios').doc(currentUser.uid).set({
            state: state,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            email: currentUser.email
        });
        
        setSyncStatus('synced', '‚òÅÔ∏è Sincronizado');
        
    } catch(error) {
        console.error('Erro ao salvar:', error);
        setSyncStatus('error', '‚ùå Erro ao salvar');
    }
}

// Debounce para salvar
function salvarComDebounce() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    
    if(syncTimeout) clearTimeout(syncTimeout);
    syncTimeout = setTimeout(() => {
        salvarNaNuvem();
    }, 2000);
}

// Status de sincroniza√ß√£o
function setSyncStatus(status, text) {
    const el = document.getElementById('syncStatus');
    if(el) {
        el.className = 'sync-status ' + status;
        el.textContent = text;
    }
}

// Atualizar todas as telas
function refreshAll() {
    try {
        refreshDashboard();
        renderHistorico();
        refreshRevisoes();
        refreshDisciplinas();
        refreshCiclos();
        refreshMetas();
        refreshQuestoes();
        refreshStats();
    } catch(e) {
        console.error('Erro ao atualizar:', e);
    }
}

// ==================== APP ====================
const STORAGE_KEY = 'estudosPRO';
const defaultState = { disciplinas: [], sessoes: [], revisoes: [], questoes: [], metas: { horas: 49, topicos: 10, questoes: 100, dataProva: '2026-02-22' }, intervalos: [1, 3, 7, 14, 30], cicloProgresso: [] };
let state = loadState();
let timerInterval = null;
let timerSeconds = 0;
let timerStartTime = null;
let timerPausedSeconds = 0;
let currentRevTab = 'hoje';

function loadState() { try { const s = localStorage.getItem(STORAGE_KEY); return s ? { ...defaultState, ...JSON.parse(s) } : { ...defaultState }; } catch(e) { return { ...defaultState }; } }
function saveState() { 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); 
    if(currentUser) salvarComDebounce();
}
function showToast(msg, type='success') { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = 'toast ' + type; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); }
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function navTo(page) {
    document.querySelectorAll('.nav-item').forEach(i => { i.classList.remove('active'); if(i.dataset.page === page) i.classList.add('active'); });
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    if(page === 'dashboard') refreshDashboard();
    if(page === 'registro') refreshRegistro();
    if(page === 'disciplinas') refreshDisciplinas();
    if(page === 'revisoes') refreshRevisoes();
    if(page === 'ciclos') refreshCiclos();
    if(page === 'config') refreshConfig();
    if(page === 'questoes') refreshQuestoes();
    if(page === 'metas') refreshMetas();
    if(page === 'stats') refreshStats();
    if(page === 'calendario') refreshCalendario();
}
document.querySelectorAll('.nav-item').forEach(i => i.addEventListener('click', () => { if(i.dataset.page) navTo(i.dataset.page); }));

function getWeekStart() { const n = new Date(); const d = n.getDay(); const diff = n.getDate() - d + (d === 0 ? -6 : 1); return new Date(n.setDate(diff)).toISOString().split('T')[0]; }
function getToday() { return new Date().toISOString().split('T')[0]; }
function formatDate(s) { 
    const d = new Date(s + 'T12:00:00'); 
    const diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    return { 
        day: d.getDate(), 
        month: d.toLocaleString('pt-BR', { month: 'short' }), 
        full: d.toLocaleDateString('pt-BR'),
        weekday: diasSemana[d.getDay()]
    }; 
}
function formatMins(m) { const h = Math.floor(m / 60); const mm = m % 60; return h > 0 ? (mm > 0 ? h+'h '+mm+'min' : h+'h') : mm+'min'; }
function formatTimer(s) { const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const ss = s%60; return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0'); }

// Dashboard
function refreshDashboard() {
    const hoje = getToday(); const ws = getWeekStart();
    const minsSemana = state.sessoes.filter(s => s.data >= ws).reduce((a,s) => a + s.minutos, 0);
    const horasSemana = Math.round(minsSemana / 60 * 10) / 10;
    document.getElementById('statHoras').textContent = horasSemana + 'h';
    document.getElementById('statMetaHoras').textContent = state.metas.horas || 49;
    const totalTop = state.disciplinas.reduce((a,d) => a + d.topicos.length, 0);
    const domTop = state.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'mastered').length, 0);
    document.getElementById('statTopicos').textContent = domTop;
    document.getElementById('statTotalTopicos').textContent = totalTop;
    const pend = state.revisoes.filter(r => !r.concluida).length;
    const revHoje = state.revisoes.filter(r => !r.concluida && r.data === hoje);
    document.getElementById('statRevisoes').textContent = pend;
    document.getElementById('statRevisoesHoje').textContent = revHoje.length;
    document.getElementById('navRevisoes').textContent = pend;
    const totalQ = state.questoes.reduce((a,q) => a + q.total, 0);
    const acertosQ = state.questoes.reduce((a,q) => a + q.acertos, 0);
    const taxaQ = totalQ > 0 ? Math.round((acertosQ / totalQ) * 100) : 0;
    document.getElementById('statAcertos').textContent = taxaQ + '%';
    document.getElementById('statTotalQuestoes').textContent = totalQ;
    const qSemana = state.questoes.filter(q => q.data >= ws).reduce((a,q) => a + q.total, 0);
    const pctH = Math.min(100, Math.round((horasSemana / state.metas.horas) * 100));
    const pctT = Math.min(100, Math.round((domTop / state.metas.topicos) * 100));
    const pctQ = Math.min(100, Math.round((qSemana / state.metas.questoes) * 100));
    const pctG = Math.round((pctH + pctT + pctQ) / 3);
    document.getElementById('metaPct').textContent = pctG + '%';
    document.getElementById('metaBar').style.width = pctG + '%';
    document.getElementById('goalHorasText').textContent = horasSemana + '/' + state.metas.horas + 'h';
    document.getElementById('goalHorasPct').textContent = pctH + '%';
    document.getElementById('goalTopicosText').textContent = domTop + '/' + state.metas.topicos;
    document.getElementById('goalTopicosPct').textContent = pctT + '%';
    document.getElementById('goalQuestoesText').textContent = qSemana + '/' + state.metas.questoes;
    document.getElementById('goalQuestoesPct').textContent = pctQ + '%';
    const rh = document.getElementById('revisoesHoje');
    if(!revHoje.length) { rh.innerHTML = '<div class="empty"><div class="empty-icon">‚ú®</div><div>Nenhuma revis√£o hoje!</div></div>'; }
    else { rh.innerHTML = revHoje.slice(0,5).map(r => { const disc = state.disciplinas.find(d => d.id === r.disciplinaId); const top = disc?.topicos.find(t => t.id === r.topicoId); const {day,month} = formatDate(r.data); return '<div class="review-item pending"><div class="review-date"><div class="review-day">'+day+'</div><div class="review-month">'+month+'</div></div><div class="review-info"><div class="review-subject">'+(disc?.nome||'?')+'</div><div class="review-topic">'+(top?.nome||'Geral')+'</div></div><button class="btn btn-sm btn-success" onclick="concluirRev('+r.id+')">‚úì</button></div>'; }).join(''); }
    refreshStreakXP();
    const dp = document.getElementById('disciplinasProgress');
    if(!state.disciplinas.length) { dp.innerHTML = '<div class="empty"><div class="empty-icon">üìö</div><div>Cadastre disciplinas</div></div>'; }
    else { dp.innerHTML = state.disciplinas.map(d => { const t = d.topicos.length; const done = d.topicos.filter(x => x.status === 'mastered').length; const pct = t > 0 ? Math.round((done/t)*100) : 0; return '<div class="disc-item"><div class="disc-header"><span class="disc-name">'+d.nome+'</span><span class="disc-pct">'+pct+'%</span></div><div class="disc-bar"><div class="disc-fill" style="width:'+pct+'%"></div></div></div>'; }).join(''); }
}

// Registro
function refreshRegistro() {
    const opts = '<option value="">Selecione</option>' + state.disciplinas.map(d => '<option value="'+d.id+'">'+d.nome+'</option>').join('');
    document.getElementById('timerDisciplina').innerHTML = opts;
    document.getElementById('manualDisciplina').innerHTML = opts;
    document.getElementById('manualData').value = getToday();
    document.getElementById('timerTopico').innerHTML = '<option value="">Geral</option>';
    document.getElementById('manualTopico').innerHTML = '<option value="">Geral</option>';
    renderHistorico();
}
function updateTimerTopicos() { const did = parseInt(document.getElementById('timerDisciplina').value); const sel = document.getElementById('timerTopico'); sel.innerHTML = '<option value="">Geral</option>'; const d = state.disciplinas.find(x => x.id === did); if(d) d.topicos.forEach(t => sel.innerHTML += '<option value="'+t.id+'">'+t.nome+'</option>'); }
function updateManualTopicos() { const did = parseInt(document.getElementById('manualDisciplina').value); const sel = document.getElementById('manualTopico'); sel.innerHTML = '<option value="">Geral</option>'; const d = state.disciplinas.find(x => x.id === did); if(d) d.topicos.forEach(t => sel.innerHTML += '<option value="'+t.id+'">'+t.nome+'</option>'); }



// REORDENAR T√ìPICOS - Drag and Drop
let dragData = null;

function onDragStart(e, discId, index) {
    dragData = { discId, index };
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function onDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const item = e.target.closest('.topic-item');
    if(item && !item.classList.contains('dragging')) {
        // Remover classe de todos
        document.querySelectorAll('.topic-item.drag-over').forEach(el => el.classList.remove('drag-over'));
        item.classList.add('drag-over');
    }
}

function onDrop(e, discId, targetIndex) {
    e.preventDefault();
    document.querySelectorAll('.topic-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    
    if(!dragData || dragData.discId !== discId) return;
    
    const sourceIndex = dragData.index;
    if(sourceIndex === targetIndex) return;
    
    const d = state.disciplinas.find(x => x.id === discId);
    if(!d) return;
    
    // Guardar posi√ß√£o de scroll
    const accordion = document.getElementById('acc-' + discId);
    const accordionBody = accordion?.querySelector('.accordion-body');
    const scrollTop = accordionBody?.scrollTop || 0;
    
    // Mover item
    const [item] = d.topicos.splice(sourceIndex, 1);
    d.topicos.splice(targetIndex, 0, item);
    
    saveState();
    
    // Refresh mantendo estado
    refreshDisciplinasPreserveState(discId, scrollTop);
}

function onDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.topic-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    dragData = null;
}

function refreshDisciplinasPreserveState(openDiscId, scrollTop) {
    refreshDisciplinas();
    
    // Reabrir accordion
    const accordion = document.getElementById('acc-' + openDiscId);
    if(accordion) {
        accordion.classList.add('open');
        
        // Restaurar scroll ap√≥s render
        setTimeout(() => {
            const body = accordion.querySelector('.accordion-body');
            if(body) body.scrollTop = scrollTop;
        }, 10);
    }
}

// Fun√ß√£o para editar nome do t√≥pico
function editarNomeTopico(discId, topId) {
    const d = state.disciplinas.find(x => x.id === discId);
    const t = d?.topicos.find(x => x.id === topId);
    if(!t) return;
    
    document.getElementById('editTopicoDiscId').value = discId;
    document.getElementById('editTopicoId').value = topId;
    document.getElementById('editTopicoNome').value = t.nome;
    openModal('modalEditTopico');
}

function salvarEdicaoTopico() {
    const discId = parseFloat(document.getElementById('editTopicoDiscId').value);
    const topId = parseFloat(document.getElementById('editTopicoId').value);
    const novoNome = document.getElementById('editTopicoNome').value.trim();
    
    if(!novoNome) {
        showToast('Nome n√£o pode ser vazio!', 'error');
        return;
    }
    
    const d = state.disciplinas.find(x => x.id === discId);
    const t = d?.topicos.find(x => x.id === topId);
    if(!t) return;
    
    // Guardar estado
    const accordion = document.getElementById('acc-' + discId);
    const accordionBody = accordion?.querySelector('.accordion-body');
    const scrollTop = accordionBody?.scrollTop || 0;
    
    t.nome = novoNome;
    saveState();
    
    closeModal('modalEditTopico');
    refreshDisciplinasPreserveState(discId, scrollTop);
    showToast('T√≥pico renomeado!');
}

// ANOTA√á√ïES
function abrirAnotacao(discId, topId) {
    const d = state.disciplinas.find(x => x.id === discId);
    const t = d?.topicos.find(x => x.id === topId);
    if(!t) return;
    
    document.getElementById('anotacaoDiscId').value = discId;
    document.getElementById('anotacaoTopId').value = topId;
    document.getElementById('anotacaoTopicoNome').textContent = t.nome;
    document.getElementById('anotacaoTexto').value = t.anotacao || '';
    openModal('modalAnotacao');
}

function salvarAnotacao() {
    const discId = parseFloat(document.getElementById('anotacaoDiscId').value);
    const topId = parseFloat(document.getElementById('anotacaoTopId').value);
    const texto = document.getElementById('anotacaoTexto').value.trim();
    
    const d = state.disciplinas.find(x => x.id === discId);
    const t = d?.topicos.find(x => x.id === topId);
    if(t) {
        t.anotacao = texto;
        saveState();
        closeModal('modalAnotacao');
        showToast('Anota√ß√£o salva!');
        
        // Atualizar visual
        const wasOpen = document.getElementById('acc-'+discId)?.classList.contains('open');
        refreshDisciplinas();
        if(wasOpen) document.getElementById('acc-'+discId)?.classList.add('open');
    }
}

// LINKS
function abrirLinks(discId) {
    document.getElementById('linksDiscId').value = discId;
    document.getElementById('linkTitulo').value = '';
    document.getElementById('linkUrl').value = '';
    renderLinksList(discId);
    openModal('modalLinks');
}

function renderLinksList(discId) {
    const d = state.disciplinas.find(x => x.id === discId);
    const links = d?.links || [];
    const container = document.getElementById('linksList');
    
    if(!links.length) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">Nenhum link salvo</div>';
        return;
    }
    
    container.innerHTML = links.map((link, i) => `
        <div class="link-item">
            <a href="${link.url}" target="_blank" rel="noopener">
                <span class="link-title">${link.titulo || 'Link'}</span>
                <span class="link-url">${link.url}</span>
            </a>
            <button class="link-delete" onclick="removerLink(${discId}, ${i})">üóëÔ∏è</button>
        </div>
    `).join('');
}

function adicionarLink() {
    const discId = parseFloat(document.getElementById('linksDiscId').value);
    const titulo = document.getElementById('linkTitulo').value.trim();
    const url = document.getElementById('linkUrl').value.trim();
    
    if(!url) {
        showToast('Digite a URL!', 'error');
        return;
    }
    
    const d = state.disciplinas.find(x => x.id === discId);
    if(d) {
        if(!d.links) d.links = [];
        d.links.push({ titulo: titulo || 'Link', url: url });
        saveState();
        
        document.getElementById('linkTitulo').value = '';
        document.getElementById('linkUrl').value = '';
        renderLinksList(discId);
        showToast('Link adicionado!');
    }
}

function removerLink(discId, index) {
    const d = state.disciplinas.find(x => x.id === discId);
    if(d && d.links) {
        d.links.splice(index, 1);
        saveState();
        renderLinksList(discId);
    }
}


// ALERTA SONORO POMODORO
function tocarAlertaPomodoro() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function beep(frequency, startTime, duration) {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.5, startTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
        
        oscillator.start(startTime);
        oscillator.stop(startTime + duration);
    }
    
    // 3 bips com intervalo
    const now = audioCtx.currentTime;
    beep(880, now, 0.2);        // Bip 1
    beep(880, now + 0.3, 0.2);  // Bip 2
    beep(1100, now + 0.6, 0.3); // Bip 3 (mais agudo e longo)
}

// POMODORO
let pomodoroAtivo = false;
let pomodoroFase = 'foco'; // foco, pausa, pausa-longa
let pomodoroCiclo = 1;
const POMODORO_FOCO = 25 * 60; // 25 min
const POMODORO_PAUSA = 5 * 60; // 5 min
const POMODORO_PAUSA_LONGA = 15 * 60; // 15 min
let pomodoroTempoFocoCompleto = 0;
let proximaFasePomodoro = null;
let proximoTempoPomodoro = 0;

function togglePomodoro() {
    pomodoroAtivo = document.getElementById('pomodoroMode').checked;
    document.getElementById('pomodoroStatus').style.display = pomodoroAtivo ? 'block' : 'none';
    
    if(pomodoroAtivo) {
        timerReset();
        pomodoroFase = 'foco';
        pomodoroCiclo = 1;
        timerSeconds = POMODORO_FOCO;
        atualizarPomodoroUI();
        document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds);
    } else {
        timerReset();
    }
}

function atualizarPomodoroUI() {
    const badge = document.getElementById('pomodoroBadge');
    if(pomodoroFase === 'foco') {
        badge.textContent = 'üçÖ Foco';
        badge.className = 'pomodoro-badge foco';
    } else if(pomodoroFase === 'pausa') {
        badge.textContent = '‚òï Pausa';
        badge.className = 'pomodoro-badge pausa';
    } else {
        badge.textContent = 'üåü Pausa Longa';
        badge.className = 'pomodoro-badge longa';
    }
    document.getElementById('pomodoroCiclo').textContent = pomodoroCiclo;
}

function pomodoroTick() {
    timerSeconds--;
    document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds);
    
    if(timerSeconds <= 0) {
        clearInterval(timerInterval);
        
        // Tocar som/notifica√ß√£o - 3 bips
        tocarAlertaPomodoro();
        
        if(pomodoroFase === 'foco') {
            // Fim do foco - N√ÉO zerar, guardar tempo para salvar
            pomodoroTempoFocoCompleto = POMODORO_FOCO; // Guardar que completou 25min
            showToast('üçÖ 25 minutos de foco conclu√≠dos! Salve ou continue para pausa.');
            
            // Habilitar salvar
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStart').textContent = '‚òï Pausa';
            document.getElementById('btnPause').disabled = true;
            document.getElementById('btnSave').disabled = false;
            
            // Preparar pr√≥xima fase mas n√£o iniciar automaticamente
            if(pomodoroCiclo >= 4) {
                proximaFasePomodoro = 'pausa-longa';
                proximoTempoPomodoro = POMODORO_PAUSA_LONGA;
            } else {
                proximaFasePomodoro = 'pausa';
                proximoTempoPomodoro = POMODORO_PAUSA;
            }
        } else {
            // Fim da pausa - voltar para foco
            if(pomodoroFase === 'pausa-longa') {
                pomodoroCiclo = 1;
                showToast('üåü Pausa longa conclu√≠da! Pronto para novo ciclo.');
            } else {
                pomodoroCiclo++;
                showToast('‚òï Pausa conclu√≠da! Pronto para focar.');
            }
            pomodoroFase = 'foco';
            timerSeconds = POMODORO_FOCO;
            pomodoroTempoFocoCompleto = 0;
            
            atualizarPomodoroUI();
            document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds);
            
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStart').textContent = '‚ñ∂Ô∏è Iniciar';
            document.getElementById('btnPause').disabled = true;
            document.getElementById('btnSave').disabled = true;
        }
    }
}



function getTopicAcertosHtml(topId) {
    const questoesTopico = state.questoes.filter(q => q.topicoId === topId);
    if(questoesTopico.length === 0) return '';
    
    const total = questoesTopico.reduce((a, q) => a + q.total, 0);
    const acertos = questoesTopico.reduce((a, q) => a + q.acertos, 0);
    const pct = Math.round((acertos / total) * 100);
    
    const classe = pct >= 70 ? 'good' : pct >= 50 ? 'medium' : 'bad';
    
    return '<span class="topic-acertos ' + classe + '">' + pct + '% (' + acertos + '/' + total + ')</span>';
}

function toggleQuestoesTimer() {
    const show = document.getElementById('timerComQuestoes').checked;
    document.getElementById('timerQuestoesFields').style.display = show ? 'block' : 'none';
}

function toggleQuestoesManual() {
    const show = document.getElementById('manualComQuestoes').checked;
    document.getElementById('manualQuestoesFields').style.display = show ? 'block' : 'none';
}

function timerStart() { 
    if(!document.getElementById('timerDisciplina').value) { showToast('Selecione disciplina!','error'); return; } 
    document.getElementById('btnStart').disabled = true; 
    document.getElementById('btnPause').disabled = false; 
    document.getElementById('btnReset').disabled = false; 
    document.getElementById('btnSave').disabled = true; 
    
    if(pomodoroAtivo) {
        // Verificar se est√° iniciando pausa ap√≥s foco
        if(proximaFasePomodoro && pomodoroTempoFocoCompleto > 0) {
            pomodoroFase = proximaFasePomodoro;
            timerSeconds = proximoTempoPomodoro;
            proximaFasePomodoro = null;
            proximoTempoPomodoro = 0;
            atualizarPomodoroUI();
            document.getElementById('btnStart').textContent = '‚ñ∂Ô∏è Iniciar';
        }
        
        // Modo Pomodoro - contagem regressiva
        timerStartTime = Date.now();
        timerInterval = setInterval(pomodoroTick, 1000);
    } else {
        // Modo normal - contagem progressiva usando timestamp
        timerStartTime = Date.now();
        timerInterval = setInterval(() => { 
            const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
            timerSeconds = timerPausedSeconds + elapsed;
            document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds); 
        }, 500);
    }
}
function timerPause() { 
    clearInterval(timerInterval); 
    timerPausedSeconds = timerSeconds; // Guardar tempo atual
    document.getElementById('btnStart').disabled = false; 
    document.getElementById('btnPause').disabled = true; 
    document.getElementById('btnSave').disabled = false; 
}
function timerReset() { 
    clearInterval(timerInterval); 
    timerStartTime = null;
    timerPausedSeconds = 0;
    
    if(pomodoroAtivo) {
        pomodoroFase = 'foco';
        pomodoroCiclo = 1;
        timerSeconds = POMODORO_FOCO;
        pomodoroTempoFocoCompleto = 0;
        proximaFasePomodoro = null;
        proximoTempoPomodoro = 0;
        atualizarPomodoroUI();
        document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds);
        document.getElementById('btnStart').textContent = '‚ñ∂Ô∏è Iniciar';
    } else {
        timerSeconds = 0; 
        document.getElementById('timerDisplay').textContent = '00:00:00'; 
    }
    
    document.getElementById('btnStart').disabled = false; 
    document.getElementById('btnPause').disabled = true; 
    document.getElementById('btnReset').disabled = true; 
    document.getElementById('btnSave').disabled = true; 
}
function timerSave() { 
    const did = parseInt(document.getElementById('timerDisciplina').value); 
    const tid = parseFloat(document.getElementById('timerTopico').value) || null; 
    
    let mins;
    if(pomodoroAtivo) {
        // No Pomodoro, usar tempo completo se terminou, sen√£o calcular parcial
        if(pomodoroTempoFocoCompleto > 0) {
            mins = Math.ceil(pomodoroTempoFocoCompleto / 60);
        } else {
            const tempoTotal = pomodoroFase === 'foco' ? POMODORO_FOCO : (pomodoroFase === 'pausa' ? POMODORO_PAUSA : POMODORO_PAUSA_LONGA);
            const tempoEstudado = tempoTotal - timerSeconds;
            mins = Math.ceil(tempoEstudado / 60);
        }
    } else {
        mins = Math.ceil(timerSeconds / 60);
    }
    
    if(mins < 1) { showToast('M√≠nimo 1 min','error'); return; } 
    const sessao = { id: Date.now(), disciplinaId: did, topicoId: tid, minutos: mins, data: getToday() }; 
    state.sessoes.push(sessao); 
    const gerarRev = document.getElementById('timerGerarRevisao').checked;
    if(gerarRev) gerarRevisoes(sessao); 
    
    // Salvar quest√µes se marcado
    let questoesMsg = '';
    if(document.getElementById('timerComQuestoes').checked) {
        const total = parseInt(document.getElementById('timerQuestoesTotal').value);
        const acertos = parseInt(document.getElementById('timerQuestoesAcertos').value);
        if(total > 0 && acertos >= 0 && acertos <= total) {
            state.questoes.push({
                id: Date.now() + Math.random(),
                sessaoId: sessao.id,
                data: getToday(),
                disciplinaId: did,
                topicoId: tid,
                fonte: 'Estudo',
                total: total,
                acertos: acertos
            });
            questoesMsg = ' +' + total + ' quest√µes.';
            // Limpar campos
            document.getElementById('timerQuestoesTotal').value = '';
            document.getElementById('timerQuestoesAcertos').value = '';
        }
    }
    
    saveState(); 
    timerReset(); 
    showToast('Sess√£o de '+formatMins(mins)+' salva!' + (gerarRev ? ' Revis√µes criadas.' : '') + questoesMsg); 
    renderHistorico(); 
}
function manualSave() { 
    const data = document.getElementById('manualData').value; 
    const did = parseInt(document.getElementById('manualDisciplina').value); 
    const tid = parseFloat(document.getElementById('manualTopico').value) || null; 
    const mins = parseInt(document.getElementById('manualTempo').value); 
    if(!data||!did||!mins) { showToast('Preencha os campos!','error'); return; } 
    const sessao = { id: Date.now(), disciplinaId: did, topicoId: tid, minutos: mins, data: data }; 
    state.sessoes.push(sessao); 
    const gerarRev = document.getElementById('manualGerarRevisao').checked;
    if(gerarRev) gerarRevisoes(sessao); 
    
    // Salvar quest√µes se marcado
    let questoesMsg = '';
    if(document.getElementById('manualComQuestoes').checked) {
        const total = parseInt(document.getElementById('manualQuestoesTotal').value);
        const acertos = parseInt(document.getElementById('manualQuestoesAcertos').value);
        if(total > 0 && acertos >= 0 && acertos <= total) {
            state.questoes.push({
                id: Date.now() + Math.random(),
                sessaoId: sessao.id,
                data: data,
                disciplinaId: did,
                topicoId: tid,
                fonte: 'Estudo',
                total: total,
                acertos: acertos
            });
            questoesMsg = ' +' + total + ' quest√µes.';
            // Limpar campos
            document.getElementById('manualQuestoesTotal').value = '';
            document.getElementById('manualQuestoesAcertos').value = '';
        }
    }
    
    saveState(); 
    document.getElementById('manualTempo').value = ''; 
    showToast('Sess√£o registrada!' + (gerarRev ? ' Revis√µes criadas.' : '') + questoesMsg); 
    renderHistorico(); 
}
function gerarRevisoes(sessao) { const base = new Date(sessao.data + 'T12:00:00'); state.intervalos.forEach(dias => { const rd = new Date(base); rd.setDate(rd.getDate() + dias); state.revisoes.push({ id: Date.now() + Math.random(), sessaoId: sessao.id, disciplinaId: sessao.disciplinaId, topicoId: sessao.topicoId, data: rd.toISOString().split('T')[0], intervalo: dias, concluida: false }); }); }
function renderHistorico() { 
    const c = document.getElementById('historicoSessoes'); 
    const ss = [...state.sessoes].sort((a,b) => b.data.localeCompare(a.data) || b.id - a.id); 
    document.getElementById('historicoCount').textContent = ss.length + ' sess√µes'; 
    
    if(!ss.length) { 
        c.innerHTML = '<div class="empty"><div class="empty-icon">üìù</div><div>Nenhuma sess√£o</div></div>'; 
        return; 
    }
    
    // Agrupar por data
    const porDia = {};
    ss.slice(0, 50).forEach(s => {
        if(!porDia[s.data]) porDia[s.data] = [];
        porDia[s.data].push(s);
    });
    
    let html = '';
    let isFirst = true;
    for(const [data, sessoes] of Object.entries(porDia)) {
        const {full, weekday} = formatDate(data);
        const totalDia = sessoes.reduce((a, s) => a + s.minutos, 0);
        
        html += '<div class="historico-dia' + (isFirst ? ' open' : '') + '">';
        html += '<div class="historico-dia-header" onclick="this.parentElement.classList.toggle(\'open\')">';
        html += '<span class="historico-dia-data"><span class="historico-arrow">‚ñ∂</span> üìÖ ' + full + ' (' + weekday + ')</span>';
        html += '<span class="historico-dia-info"><span class="historico-dia-count">' + sessoes.length + ' sess√µes</span><span class="historico-dia-total">' + formatMins(totalDia) + '</span></span>';
        html += '</div>';
        html += '<div class="historico-dia-sessoes">';
        
        sessoes.forEach(s => {
            const d = state.disciplinas.find(x => x.id === s.disciplinaId);
            const t = d?.topicos.find(x => x.id === s.topicoId);
            html += '<div class="session-item">';
            html += '<div class="session-time">' + formatMins(s.minutos) + '</div>';
            html += '<div class="session-info"><div class="session-subject">' + (d?.nome||'?') + '</div><div class="session-topic">' + (t?.nome||'Geral') + '</div></div>';
            html += '<div class="session-actions"><button class="session-edit" onclick="event.stopPropagation(); editarSessao(' + s.id + ')" title="Editar">‚úèÔ∏è</button><button class="session-delete" onclick="event.stopPropagation(); deleteSessao(' + s.id + ')" title="Excluir">üóëÔ∏è</button></div>';
            html += '</div>';
        });
        
        html += '</div></div>';
        isFirst = false;
    }
    
    c.innerHTML = html;
}

// EDITAR SESS√ÉO
function editarSessao(id) {
    const sessao = state.sessoes.find(s => s.id === id);
    if(!sessao) return;
    
    document.getElementById('editSessaoId').value = id;
    document.getElementById('editSessaoData').value = sessao.data;
    document.getElementById('editSessaoMinutos').value = sessao.minutos;
    
    // Preencher select de disciplinas
    const selectDisc = document.getElementById('editSessaoDisciplina');
    selectDisc.innerHTML = '<option value="">Selecione</option>' + 
        state.disciplinas.map(d => `<option value="${d.id}" ${d.id === sessao.disciplinaId ? 'selected' : ''}>${d.nome}</option>`).join('');
    
    // Atualizar t√≥picos e selecionar o correto
    updateEditSessaoTopicos(sessao.topicoId);
    
    // Verificar se tem quest√µes vinculadas
    const questao = state.questoes.find(q => q.sessaoId === id);
    if(questao) {
        document.getElementById('editSessaoQuestoesGroup').style.display = 'block';
        document.getElementById('editSessaoQuestoesTotal').value = questao.total;
        document.getElementById('editSessaoQuestoesAcertos').value = questao.acertos;
    } else {
        document.getElementById('editSessaoQuestoesGroup').style.display = 'none';
        document.getElementById('editSessaoQuestoesTotal').value = '';
        document.getElementById('editSessaoQuestoesAcertos').value = '';
    }
    
    openModal('modalEditSessao');
}

function updateEditSessaoTopicos(selectedTopicoId = null) {
    const discId = parseInt(document.getElementById('editSessaoDisciplina').value);
    const selectTop = document.getElementById('editSessaoTopico');
    selectTop.innerHTML = '<option value="">Geral</option>';
    
    if(discId) {
        const disc = state.disciplinas.find(d => d.id === discId);
        if(disc) {
            selectTop.innerHTML += disc.topicos.map(t => 
                `<option value="${t.id}" ${t.id === selectedTopicoId ? 'selected' : ''}>${t.nome}</option>`
            ).join('');
        }
    }
}

function salvarEdicaoSessao() {
    const id = parseFloat(document.getElementById('editSessaoId').value);
    const data = document.getElementById('editSessaoData').value;
    const disciplinaId = parseInt(document.getElementById('editSessaoDisciplina').value);
    const topicoId = parseFloat(document.getElementById('editSessaoTopico').value) || null;
    const minutos = parseInt(document.getElementById('editSessaoMinutos').value);
    
    if(!data || !disciplinaId || !minutos) {
        showToast('Preencha os campos obrigat√≥rios!', 'error');
        return;
    }
    
    // Encontrar e atualizar sess√£o
    const sessao = state.sessoes.find(s => s.id === id);
    if(sessao) {
        sessao.data = data;
        sessao.disciplinaId = disciplinaId;
        sessao.topicoId = topicoId;
        sessao.minutos = minutos;
        
        // Atualizar revis√µes vinculadas (mudar disciplina/t√≥pico)
        state.revisoes.forEach(r => {
            if(r.sessaoId === id) {
                r.disciplinaId = disciplinaId;
                r.topicoId = topicoId;
            }
        });
        
        // Atualizar quest√µes vinculadas
        const questaoExistente = state.questoes.find(q => q.sessaoId === id);
        const totalQ = parseInt(document.getElementById('editSessaoQuestoesTotal').value);
        const acertosQ = parseInt(document.getElementById('editSessaoQuestoesAcertos').value);
        
        if(questaoExistente && totalQ > 0) {
            questaoExistente.data = data;
            questaoExistente.disciplinaId = disciplinaId;
            questaoExistente.topicoId = topicoId;
            questaoExistente.total = totalQ;
            questaoExistente.acertos = Math.min(acertosQ, totalQ);
        }
        
        saveState();
        closeModal('modalEditSessao');
        showToast('Sess√£o atualizada!');
        renderHistorico();
        refreshDashboard();
    }
}

function deleteSessao(id) { 
    if(!confirm('Excluir sess√£o, revis√µes e quest√µes associadas?')) return; 
    
    // Contar itens que ser√£o exclu√≠dos
    const revisoesAssociadas = state.revisoes.filter(r => r.sessaoId === id).length;
    const questoesAssociadas = state.questoes.filter(q => q.sessaoId === id).length;
    
    // Excluir sess√£o
    state.sessoes = state.sessoes.filter(s => s.id !== id); 
    
    // Excluir revis√µes associadas
    state.revisoes = state.revisoes.filter(r => r.sessaoId !== id); 
    
    // Excluir quest√µes associadas
    state.questoes = state.questoes.filter(q => q.sessaoId !== id);
    
    saveState(); 
    
    // Feedback
    let msg = 'Sess√£o exclu√≠da';
    if(revisoesAssociadas > 0) msg += ' + ' + revisoesAssociadas + ' revis√µes';
    if(questoesAssociadas > 0) msg += ' + ' + questoesAssociadas + ' quest√µes';
    showToast(msg);
    
    renderHistorico(); 
    
    // Atualizar abas
    if(typeof refreshRevisoes === 'function') refreshRevisoes();
    if(typeof refreshDisciplinas === 'function') refreshDisciplinas();
    refreshDashboard();
}

// DISCIPLINAS - CORRIGIDO
function refreshDisciplinas() {
    const c = document.getElementById('listaDisciplinas');
    if(!state.disciplinas.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üìö</div><div>Nenhuma disciplina cadastrada.</div></div>'; return; }
    c.innerHTML = state.disciplinas.map(d => {
        const total = d.topicos.length;
        const done = d.topicos.filter(t => t.status !== 'not-studied').length;
        const pct = total > 0 ? Math.round((done/total)*100) : 0;
        const topicsHtml = d.topicos.map((t, idx) => 
            `<div class="topic-item" draggable="true" data-disc-id="${d.id}" data-top-id="${t.id}" data-index="${idx}"
                ondragstart="onDragStart(event, ${d.id}, ${idx})"
                ondragover="onDragOver(event)"
                ondrop="onDrop(event, ${d.id}, ${idx})"
                ondragend="onDragEnd(event)">
                <div class="topic-drag-handle" title="Arraste para reordenar">‚†ø</div>
                <div class="topic-num">${idx + 1}.</div>
                <div class="topic-name" onclick="event.stopPropagation(); editarNomeTopico(${d.id},${t.id})" title="Clique para editar">${t.nome}${getTopicAcertosHtml(t.id)}</div>
                <button class="topic-note-btn ${t.anotacao ? 'has-note' : ''}" onclick="event.stopPropagation(); abrirAnotacao(${d.id},${t.id})" title="${t.anotacao ? 'Ver anota√ß√£o' : 'Adicionar anota√ß√£o'}">üìù</button>
                <div class="topic-status">
                    <button class="status-btn s1 ${t.status==='not-studied'?'active':''}" onclick="event.stopPropagation(); setStatus(${d.id},${t.id},'not-studied',this)" title="N√£o estudado">‚Äî</button>
                    <button class="status-btn s2 ${t.status==='studied'?'active':''}" onclick="event.stopPropagation(); setStatus(${d.id},${t.id},'studied',this)" title="Estudado">E</button>
                    <button class="status-btn s3 ${t.status==='revised'?'active':''}" onclick="event.stopPropagation(); setStatus(${d.id},${t.id},'revised',this)" title="Revisado">R</button>
                    <button class="status-btn s4 ${t.status==='mastered'?'active':''}" onclick="event.stopPropagation(); setStatus(${d.id},${t.id},'mastered',this)" title="Dominado">‚úì</button>
                </div>
                <button class="topic-delete" onclick="event.stopPropagation(); deleteTopic(${d.id},${t.id})">√ó</button>
            </div>`
        ).join('');
        
        return `<div class="accordion" id="acc-${d.id}">
            <div class="accordion-header" onclick="toggleAcc(${d.id})">
                <div class="accordion-title">üìò ${d.nome}</div>
                <div style="display:flex;align-items:center;gap:12px">
                    <span class="accordion-meta">${total} t√≥picos ‚Ä¢ ${pesoToText(d.peso)} ‚Ä¢ ${pct}%</span>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
            </div>
            <div class="accordion-body">
                <div class="accordion-content">
                    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); openEditDisc(${d.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); openAddTopic(${d.id})">+ T√≥pico</button>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); abrirLinks(${d.id})">üîó Links</button>
                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteDisc(${d.id})">üóëÔ∏è</button>
                    </div>
                    <div class="status-legend">
                        <span><div class="status-dot s1"></div> N√£o estudado</span>
                        <span><div class="status-dot s2"></div> Estudado</span>
                        <span><div class="status-dot s3"></div> Revisado</span>
                        <span><div class="status-dot s4"></div> Dominado</span>
                    </div>
                    ${topicsHtml}
                </div>
            </div>
        </div>`;
    }).join('');
}

function toggleAcc(id) { document.getElementById('acc-'+id).classList.toggle('open'); }
function salvarDisciplina() { const nome = document.getElementById('discNome').value.trim(); const peso = parseInt(document.getElementById('discPeso').value); const topText = document.getElementById('discTopicos').value.trim(); if(!nome) { showToast('Digite o nome!','error'); return; } const topicos = topText.split('\n').map(t => t.trim()).filter(t => t).map(t => ({ id: Date.now() + Math.random(), nome: t, status: 'not-studied' })); state.disciplinas.push({ id: Date.now(), nome, peso, topicos }); saveState(); closeModal('modalDisc'); document.getElementById('discNome').value = ''; document.getElementById('discTopicos').value = ''; showToast('Disciplina criada!'); refreshDisciplinas(); }
function openEditDisc(id) { const d = state.disciplinas.find(x => x.id === id); if(d) { document.getElementById('editDiscId').value = id; document.getElementById('editDiscNome').value = d.nome; document.getElementById('editDiscPeso').value = d.peso; openModal('modalEditDisc'); } }
function atualizarDisciplina() { const id = parseInt(document.getElementById('editDiscId').value); const d = state.disciplinas.find(x => x.id === id); if(d) { d.nome = document.getElementById('editDiscNome').value.trim(); d.peso = parseInt(document.getElementById('editDiscPeso').value); saveState(); closeModal('modalEditDisc'); showToast('Atualizada!'); refreshDisciplinas(); } }
function deleteDisc(id) { if(!confirm('Excluir disciplina?')) return; state.disciplinas = state.disciplinas.filter(d => d.id !== id); saveState(); showToast('Exclu√≠da'); refreshDisciplinas(); }
function openAddTopic(discId) { document.getElementById('addTopicDiscId').value = discId; document.getElementById('addTopicNome').value = ''; openModal('modalAddTopic'); }
function salvarNovoTopico() { 
    const discId = parseInt(document.getElementById('addTopicDiscId').value); 
    const nome = document.getElementById('addTopicNome').value.trim(); 
    if(!nome) { showToast('Digite o nome!','error'); return; } 
    const d = state.disciplinas.find(x => x.id === discId); 
    if(d) { 
        d.topicos.push({ id: Date.now() + Math.random(), nome, status: 'not-studied' }); 
        saveState(); 
        closeModal('modalAddTopic'); 
        showToast('T√≥pico adicionado!'); 
        // Refresh mantendo accordion aberto
        refreshDisciplinas();
        document.getElementById('acc-'+discId)?.classList.add('open');
    } 
}
function deleteTopic(discId, topId) { 
    const d = state.disciplinas.find(x => x.id === discId); 
    if(d) { 
        d.topicos = d.topicos.filter(t => t.id !== topId); 
        saveState(); 
        // Refresh para renumerar
        const wasOpen = document.getElementById('acc-'+discId)?.classList.contains('open');
        refreshDisciplinas();
        if(wasOpen) document.getElementById('acc-'+discId)?.classList.add('open');
    } 
}
function setStatus(discId, topId, status, btn) { const d = state.disciplinas.find(x => x.id === discId); if(d) { const t = d.topicos.find(x => x.id === topId); if(t) { t.status = status; saveState(); const topicItem = btn.closest('.topic-item'); if(topicItem) { topicItem.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } } } }

// Revis√µes
function refreshRevisoes() {
    const hoje = getToday();
    const pendentes = state.revisoes.filter(r => !r.concluida && r.data >= hoje);
    const atrasadas = state.revisoes.filter(r => !r.concluida && r.data < hoje);
    const concluidas = state.revisoes.filter(r => r.concluida);
    const revHoje = state.revisoes.filter(r => !r.concluida && r.data === hoje);
    document.getElementById('revPendentes').textContent = pendentes.length;
    document.getElementById('revAtrasadas').textContent = atrasadas.length;
    document.getElementById('revConcluidas').textContent = concluidas.length;
    document.getElementById('tabHojeCount').textContent = revHoje.length;
    document.getElementById('tabPendCount').textContent = pendentes.length;
    document.getElementById('tabAtrasadasCount').textContent = atrasadas.length;
    document.getElementById('navRevisoes').textContent = pendentes.length + atrasadas.length;
    renderRevList();
}
function switchRevTab(tab) { currentRevTab = tab; document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active')); document.querySelector('.tab[data-tab="'+tab+'"]').classList.add('active'); renderRevList(); }
function renderRevList() {
    const c = document.getElementById('revContent'); const hoje = getToday(); let lista = [], emptyMsg = '';
    if(currentRevTab === 'hoje') { lista = state.revisoes.filter(r => !r.concluida && r.data === hoje); emptyMsg = 'Nenhuma revis√£o para hoje! üéâ'; }
    else if(currentRevTab === 'pendentes') { lista = state.revisoes.filter(r => !r.concluida && r.data >= hoje); emptyMsg = 'Nenhuma revis√£o pendente!'; }
    else if(currentRevTab === 'atrasadas') { lista = state.revisoes.filter(r => !r.concluida && r.data < hoje); emptyMsg = 'Nenhuma revis√£o atrasada! ‚ú®'; }
    else { lista = state.revisoes.filter(r => r.concluida); emptyMsg = 'Nenhuma revis√£o conclu√≠da ainda.'; }
    if(!lista.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">'+(currentRevTab === 'atrasadas' ? '‚ú®' : 'üìã')+'</div><div>'+emptyMsg+'</div></div>'; return; }
    lista.sort((a,b) => { if(currentRevTab === 'concluidas') return (b.dataConclusao||'').localeCompare(a.dataConclusao||''); return a.data.localeCompare(b.data); });
    c.innerHTML = lista.slice(0, 50).map(r => { const disc = state.disciplinas.find(d => d.id === r.disciplinaId); const top = disc?.topicos.find(t => t.id === r.topicoId); const {day, month, full} = formatDate(r.data); const isOverdue = !r.concluida && r.data < hoje; const isDone = r.concluida; const statusClass = isDone ? 'done' : (isOverdue ? 'overdue' : 'pending'); const badgeClass = isDone ? 'badge-done' : (isOverdue ? 'badge-overdue' : 'badge-pending'); const badgeText = isDone ? 'Conclu√≠da' : (isOverdue ? 'Atrasada' : 'Pendente'); return '<div class="review-item '+statusClass+'"><div class="review-date"><div class="review-day">'+day+'</div><div class="review-month">'+month+'</div></div><div class="review-info"><div class="review-subject">'+(disc?.nome||'?')+'</div><div class="review-topic">'+(top?.nome||'Geral')+'</div><div class="review-interval">R'+r.intervalo+' ‚Ä¢ '+full+'</div></div><span class="badge '+badgeClass+'">'+badgeText+'</span>'+(!isDone ? '<div class="review-actions"><button class="btn btn-sm btn-success" onclick="concluirRev('+r.id+')">‚úì</button><button class="btn btn-sm btn-secondary" onclick="adiarRev('+r.id+')">‚Üí</button></div>' : '')+'</div>'; }).join('');
}
function concluirRev(id) { const r = state.revisoes.find(x => x.id === id); if(r) { r.concluida = true; r.dataConclusao = getToday(); saveState(); showToast('Revis√£o conclu√≠da!'); refreshRevisoes(); refreshDashboard(); } }
function adiarRev(id) { const r = state.revisoes.find(x => x.id === id); if(r) { const d = new Date(r.data + 'T12:00:00'); d.setDate(d.getDate() + 1); r.data = d.toISOString().split('T')[0]; saveState(); showToast('Adiada para ' + formatDate(r.data).full); refreshRevisoes(); } }





// STREAK, XP E CONQUISTAS
const BADGES = [
    { id: 'first_session', icon: 'üéØ', nome: 'Primeira Sess√£o', desc: 'Registrou a primeira sess√£o', check: (s) => s.sessoes.length >= 1 },
    { id: 'hours_10', icon: '‚è∞', nome: '10 Horas', desc: 'Estudou 10 horas no total', check: (s) => s.sessoes.reduce((a,x) => a + x.minutos, 0) >= 600 },
    { id: 'hours_50', icon: 'üìö', nome: '50 Horas', desc: 'Estudou 50 horas no total', check: (s) => s.sessoes.reduce((a,x) => a + x.minutos, 0) >= 3000 },
    { id: 'hours_100', icon: 'üèÜ', nome: '100 Horas', desc: 'Estudou 100 horas no total', check: (s) => s.sessoes.reduce((a,x) => a + x.minutos, 0) >= 6000 },
    { id: 'hours_200', icon: 'üëë', nome: '200 Horas', desc: 'Estudou 200 horas no total', check: (s) => s.sessoes.reduce((a,x) => a + x.minutos, 0) >= 12000 },
    { id: 'streak_3', icon: 'üî•', nome: '3 Dias', desc: 'Streak de 3 dias', check: (s) => calcularStreak(s) >= 3 },
    { id: 'streak_7', icon: 'üí™', nome: '7 Dias', desc: 'Streak de 7 dias', check: (s) => calcularStreak(s) >= 7 },
    { id: 'streak_14', icon: '‚ö°', nome: '14 Dias', desc: 'Streak de 14 dias', check: (s) => calcularStreak(s) >= 14 },
    { id: 'streak_30', icon: 'üåü', nome: '30 Dias', desc: 'Streak de 30 dias', check: (s) => calcularStreak(s) >= 30 },
    { id: 'topics_10', icon: 'üìñ', nome: '10 T√≥picos', desc: 'Dominou 10 t√≥picos', check: (s) => s.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'mastered').length, 0) >= 10 },
    { id: 'topics_50', icon: 'üéì', nome: '50 T√≥picos', desc: 'Dominou 50 t√≥picos', check: (s) => s.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'mastered').length, 0) >= 50 },
    { id: 'questions_100', icon: '‚ùì', nome: '100 Quest√µes', desc: 'Resolveu 100 quest√µes', check: (s) => s.questoes.reduce((a,q) => a + q.total, 0) >= 100 },
    { id: 'questions_500', icon: 'üß†', nome: '500 Quest√µes', desc: 'Resolveu 500 quest√µes', check: (s) => s.questoes.reduce((a,q) => a + q.total, 0) >= 500 },
    { id: 'accuracy_80', icon: 'üéØ', nome: 'Precis√£o 80%', desc: 'Taxa de acertos acima de 80%', check: (s) => { const t = s.questoes.reduce((a,q) => a + q.total, 0); const a = s.questoes.reduce((a,q) => a + q.acertos, 0); return t >= 50 && (a/t) >= 0.8; } },
    { id: 'reviews_50', icon: 'üîÑ', nome: '50 Revis√µes', desc: 'Completou 50 revis√µes', check: (s) => s.revisoes.filter(r => r.concluida).length >= 50 },
];

// Sistema de 1000 n√≠veis com progress√£o exponencial
// F√≥rmula: XP para n√≠vel N = 10 * N^1.5 (acumulado)
// N√≠veis 1-50 s√£o mais r√°pidos, depois fica mais dif√≠cil

const TITULOS_NIVEL = [
    { min: 1, max: 10, titulo: 'Noob', emoji: 'ü•í' },
    { min: 11, max: 25, titulo: 'Calouro', emoji: 'üê£' },
    { min: 26, max: 50, titulo: 'Aprendiz', emoji: 'üìó' },
    { min: 51, max: 75, titulo: 'Estudante', emoji: 'üìò' },
    { min: 76, max: 100, titulo: 'Dedicado', emoji: 'üìô' },
    { min: 101, max: 150, titulo: 'Aplicado', emoji: 'üí™' },
    { min: 151, max: 200, titulo: 'Focado', emoji: 'üéØ' },
    { min: 201, max: 275, titulo: 'Esfor√ßado', emoji: 'üî•' },
    { min: 276, max: 350, titulo: 'Guerreiro', emoji: '‚öîÔ∏è' },
    { min: 351, max: 425, titulo: 'Veterano', emoji: 'üõ°Ô∏è' },
    { min: 426, max: 500, titulo: 'Expert', emoji: 'üß†' },
    { min: 501, max: 600, titulo: 'Avan√ßado', emoji: 'üöÄ' },
    { min: 601, max: 700, titulo: 'Mestre', emoji: 'üéì' },
    { min: 701, max: 800, titulo: 'Gr√£o-Mestre', emoji: 'üëë' },
    { min: 801, max: 900, titulo: 'S√°bio', emoji: 'üßô' },
    { min: 901, max: 950, titulo: 'Lend√°rio', emoji: '‚≠ê' },
    { min: 951, max: 999, titulo: 'M√≠tico', emoji: 'üåü' },
    { min: 1000, max: 1000, titulo: 'JUIZ APROVADO', emoji: '‚öñÔ∏è' },
];

function calcularXPParaNivel(nivel) {
    // Progress√£o suave: primeiros n√≠veis r√°pidos, depois mais lento
    // N√≠vel 1: 0 XP, N√≠vel 2: 15 XP, N√≠vel 50: ~3500 XP, N√≠vel 100: ~10000 XP
    if(nivel <= 1) return 0;
    return Math.floor(10 * Math.pow(nivel, 1.5));
}

function getNivelPorXP(xp) {
    // Busca bin√°ria para encontrar o n√≠vel
    let nivel = 1;
    for(let n = 1; n <= 1000; n++) {
        if(xp >= calcularXPParaNivel(n)) {
            nivel = n;
        } else {
            break;
        }
    }
    return nivel;
}

function getTituloPorNivel(nivel) {
    for(const t of TITULOS_NIVEL) {
        if(nivel >= t.min && nivel <= t.max) {
            return { titulo: t.titulo, emoji: t.emoji };
        }
    }
    return { titulo: 'Noob', emoji: 'ü•í' };
}

function calcularStreak(s) {
    if(!s.sessoes.length) return 0;
    
    // Pegar datas √∫nicas ordenadas (mais recente primeiro)
    const datasUnicas = [...new Set(s.sessoes.map(x => x.data))].sort().reverse();
    if(!datasUnicas.length) return 0;
    
    // Calcular hoje e ontem no fuso local
    const hoje = getToday();
    const ontemDate = new Date();
    ontemDate.setDate(ontemDate.getDate() - 1);
    const ontem = ontemDate.toISOString().split('T')[0];
    
    // A √∫ltima data de estudo
    const ultimaData = datasUnicas[0];
    
    // Se n√£o estudou hoje nem ontem, streak = 0
    if(ultimaData !== hoje && ultimaData !== ontem) return 0;
    
    // Calcular streak contando dias consecutivos para tr√°s
    let streak = 1;
    
    for(let i = 0; i < datasUnicas.length - 1; i++) {
        const dataAtual = datasUnicas[i];
        const proximaData = datasUnicas[i + 1];
        
        // Calcular diferen√ßa em dias
        const d1 = new Date(dataAtual + 'T00:00:00');
        const d2 = new Date(proximaData + 'T00:00:00');
        const diffDias = Math.round((d1 - d2) / (1000 * 60 * 60 * 24));
        
        // Se a diferen√ßa √© exatamente 1 dia, continua o streak
        if(diffDias === 1) {
            streak++;
        } else {
            // Quebrou a sequ√™ncia
            break;
        }
    }
    
    return streak;
}

function calcularXP(s) {
    let xp = 0;
    
    // XP por horas estudadas (10 XP por hora)
    xp += Math.floor(s.sessoes.reduce((a,x) => a + x.minutos, 0) / 60) * 10;
    
    // XP por t√≥picos dominados (20 XP cada)
    xp += s.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'mastered').length, 0) * 20;
    
    // XP por quest√µes resolvidas (1 XP cada)
    xp += s.questoes.reduce((a,q) => a + q.total, 0);
    
    // XP por revis√µes conclu√≠das (5 XP cada)
    xp += s.revisoes.filter(r => r.concluida).length * 5;
    
    // XP por badges (50 XP cada)
    xp += (s.badgesEarned || []).length * 50;
    
    return xp;
}

function getNivel(xp) {
    const nivel = getNivelPorXP(xp);
    const { titulo, emoji } = getTituloPorNivel(nivel);
    const xpAtual = calcularXPParaNivel(nivel);
    const xpProximo = calcularXPParaNivel(nivel + 1);
    
    return {
        nivel: nivel,
        nome: titulo,
        emoji: emoji,
        xpMin: xpAtual,
        xpMax: xpProximo
    };
}

function refreshStreakXP() {
    // Streak
    const streak = calcularStreak(state);
    document.getElementById('streakDias').textContent = streak;
    
    // XP e N√≠vel
    const xp = calcularXP(state);
    const nivel = getNivel(xp);
    const xpNoNivel = xp - nivel.xpMin;
    const xpParaProximo = nivel.xpMax - nivel.xpMin;
    const pctNivel = Math.min(100, Math.round((xpNoNivel / xpParaProximo) * 100));
    
    document.getElementById('xpLevel').textContent = nivel.emoji + ' N√≠vel ' + nivel.nivel;
    document.getElementById('xpTitle').textContent = nivel.nome;
    document.getElementById('xpCurrent').textContent = xp;
    document.getElementById('xpNext').textContent = nivel.xpMax;
    document.getElementById('xpFill').style.width = pctNivel + '%';
    
    // Badges
    if(!state.badgesEarned) state.badgesEarned = [];
    
    let newBadge = false;
    BADGES.forEach(b => {
        if(!state.badgesEarned.includes(b.id) && b.check(state)) {
            state.badgesEarned.push(b.id);
            newBadge = true;
        }
    });
    
    if(newBadge) saveState();
    
    document.getElementById('badgesList').innerHTML = BADGES.slice(0, 10).map(b => {
        const earned = state.badgesEarned.includes(b.id);
        return `<span class="badge-item ${earned ? 'earned' : ''}" title="${b.nome}: ${b.desc}">${b.icon}</span>`;
    }).join('');
}


// IMPORTAR T√ìPICOS EM LOTE
function abrirImportarTopicos() {
    const select = document.getElementById('importTopicosDisc');
    select.innerHTML = '<option value="">Selecione a disciplina</option>' +
        state.disciplinas.map(d => `<option value="${d.id}">${d.nome}</option>`).join('');
    document.getElementById('importTopicosLista').value = '';
    openModal('modalImportTopicos');
}

function importarTopicosLote() {
    const discId = parseInt(document.getElementById('importTopicosDisc').value);
    const lista = document.getElementById('importTopicosLista').value;
    
    if(!discId) {
        showToast('Selecione uma disciplina!', 'error');
        return;
    }
    
    const disc = state.disciplinas.find(d => d.id === discId);
    if(!disc) return;
    
    // Processar lista
    const linhas = lista.split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0);
    
    if(linhas.length === 0) {
        showToast('Cole a lista de t√≥picos!', 'error');
        return;
    }
    
    // Adicionar t√≥picos
    let adicionados = 0;
    linhas.forEach(nome => {
        // Verificar se j√° existe
        const existe = disc.topicos.some(t => t.nome.toLowerCase() === nome.toLowerCase());
        if(!existe) {
            disc.topicos.push({
                id: Date.now() + Math.random(),
                nome: nome,
                status: 'not-studied',
                anotacao: ''
            });
            adicionados++;
        }
    });
    
    saveState();
    closeModal('modalImportTopicos');
    showToast(`${adicionados} t√≥picos importados!`);
    refreshDisciplinas();
    
    // Abrir o accordion da disciplina
    setTimeout(() => {
        document.getElementById('acc-' + discId)?.classList.add('open');
    }, 100);
}

// CALEND√ÅRIO
let calendarioMes = new Date().getMonth();
let calendarioAno = new Date().getFullYear();

function refreshCalendario() {
    const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    
    document.getElementById('calendarioMesAno').textContent = meses[calendarioMes] + ' ' + calendarioAno;
    
    // Meta di√°ria (semanal / 7)
    const metaDiaria = (state.metas.horas || 49) / 7;
    
    // Mostrar meta di√°ria na legenda
    document.getElementById('calendarioMetaDiaria').textContent = 'Meta: ' + metaDiaria.toFixed(1) + 'h/dia';
    
    const grid = document.getElementById('calendarioGrid');
    const hoje = new Date();
    const hojeStr = hoje.toISOString().split('T')[0];
    
    // Headers dos dias
    const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
    let html = diasSemana.map(d => `<div class="cal-header">${d}</div>`).join('');
    
    // Primeiro dia do m√™s
    const primeiroDia = new Date(calendarioAno, calendarioMes, 1);
    const ultimoDia = new Date(calendarioAno, calendarioMes + 1, 0);
    
    // Dias vazios antes do primeiro dia
    for(let i = 0; i < primeiroDia.getDay(); i++) {
        html += '<div class="cal-dia outro-mes"></div>';
    }
    
    // Dias do m√™s
    for(let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const dataStr = `${calendarioAno}-${String(calendarioMes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const dataObj = new Date(calendarioAno, calendarioMes, dia);
        
        // Calcular horas estudadas nesse dia
        const minutosDia = state.sessoes
            .filter(s => s.data === dataStr)
            .reduce((a, s) => a + s.minutos, 0);
        const horasDia = minutosDia / 60;
        
        // Determinar classe
        let classe = 'cal-dia';
        if(dataStr === hojeStr) classe += ' hoje';
        
        if(dataObj > hoje) {
            classe += ' futuro';
        } else if(horasDia >= metaDiaria) {
            classe += ' meta-ok';
        } else if(horasDia > 0) {
            classe += ' meta-parcial';
        } else if(dataObj <= hoje) {
            classe += ' meta-nao';
        }
        
        const tempoStr = horasDia > 0 ? horasDia.toFixed(1) + 'h' : '';
        
        html += `<div class="${classe}" onclick="mostrarDiaDetalhe('${dataStr}')">
            <div class="cal-dia-num">${dia}</div>
            <div class="cal-dia-tempo">${tempoStr}</div>
        </div>`;
    }
    
    grid.innerHTML = html;
}

function mesAnterior() {
    calendarioMes--;
    if(calendarioMes < 0) {
        calendarioMes = 11;
        calendarioAno--;
    }
    refreshCalendario();
}

function mesProximo() {
    calendarioMes++;
    if(calendarioMes > 11) {
        calendarioMes = 0;
        calendarioAno++;
    }
    refreshCalendario();
}

function mostrarDiaDetalhe(dataStr) {
    const dataObj = new Date(dataStr + 'T12:00:00');
    const hoje = new Date();
    
    if(dataObj > hoje) return; // N√£o mostrar futuro
    
    const sessoesDia = state.sessoes.filter(s => s.data === dataStr);
    const questoesDia = state.questoes.filter(q => q.data === dataStr);
    
    const container = document.getElementById('calendarioDiaDetalhe');
    const titulo = document.getElementById('calendarioDiaTitulo');
    const conteudo = document.getElementById('calendarioDiaConteudo');
    
    const {full} = formatDate(dataStr);
    titulo.textContent = 'üìÖ ' + full;
    
    if(sessoesDia.length === 0 && questoesDia.length === 0) {
        conteudo.innerHTML = '<div class="empty" style="padding:20px;"><div class="empty-icon">üò¥</div><div>Nenhum estudo registrado</div></div>';
    } else {
        // Agrupar por disciplina
        const porDisc = {};
        sessoesDia.forEach(s => {
            const disc = state.disciplinas.find(d => d.id === s.disciplinaId);
            const nome = disc?.nome || 'Desconhecida';
            if(!porDisc[nome]) porDisc[nome] = { minutos: 0, topicos: [] };
            porDisc[nome].minutos += s.minutos;
            
            const topico = disc?.topicos.find(t => t.id === s.topicoId);
            if(topico && !porDisc[nome].topicos.includes(topico.nome)) {
                porDisc[nome].topicos.push(topico.nome);
            }
        });
        
        let html = '';
        for(const [nome, dados] of Object.entries(porDisc)) {
            html += `<div class="cal-detalhe-item">
                <div class="cal-detalhe-disc">üìö ${nome}</div>
                <div class="cal-detalhe-tempo">‚è±Ô∏è ${formatMins(dados.minutos)}</div>
                ${dados.topicos.length > 0 ? '<div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px;">üìñ ' + dados.topicos.join(', ') + '</div>' : ''}
            </div>`;
        }
        
        // Quest√µes
        if(questoesDia.length > 0) {
            const totalQ = questoesDia.reduce((a, q) => a + q.total, 0);
            const acertosQ = questoesDia.reduce((a, q) => a + q.acertos, 0);
            const pct = Math.round((acertosQ / totalQ) * 100);
            html += `<div class="cal-detalhe-item">
                <div class="cal-detalhe-disc">‚ùì Quest√µes</div>
                <div class="cal-detalhe-tempo">${acertosQ}/${totalQ} (${pct}%)</div>
            </div>`;
        }
        
        // Total do dia
        const totalMin = sessoesDia.reduce((a, s) => a + s.minutos, 0);
        html += `<div style="text-align:center;padding:12px;font-weight:600;color:var(--accent);">
            Total: ${formatMins(totalMin)}
        </div>`;
        
        conteudo.innerHTML = html;
    }
    
    container.style.display = 'block';
}

// TEMA
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const newTheme = current === 'light' ? 'dark' : 'light';
    
    html.setAttribute('data-theme', newTheme);
    document.getElementById('themeIcon').textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    
    // Salvar prefer√™ncia
    state.tema = newTheme;
    saveState();
}

function loadTheme() {
    const tema = state.tema || 'dark';
    document.documentElement.setAttribute('data-theme', tema);
    document.getElementById('themeIcon').textContent = tema === 'light' ? '‚òÄÔ∏è' : 'üåô';
}

function pesoToText(peso) {
    const niveis = {
        1: 'üü¢ Domino bem',
        2: 'üîµ Sei razo√°vel', 
        3: 'üü° M√©dio',
        4: 'üü† Sei pouco',
        5: 'üî¥ N√£o sei nada'
    };
    return niveis[peso] || 'Peso ' + peso;
}

function pesoToShort(peso) {
    const niveis = { 1: 'üü¢', 2: 'üîµ', 3: 'üü°', 4: 'üü†', 5: 'üî¥' };
    return niveis[peso] || '';
}

// CICLOS
const CORES_CICLO = ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6', '#f97316', '#84cc16', '#3b82f6', '#a855f7'];

function refreshCiclos() {
    const container = document.getElementById('cicloDiscList');
    if(!state.disciplinas.length) {
        container.innerHTML = '<div class="empty" style="padding:16px"><div class="empty-icon">üìö</div><div>Cadastre disciplinas primeiro</div></div>';
        return;
    }
    container.innerHTML = state.disciplinas.map(d => 
        `<div class="ciclo-disc-item">
            <input type="checkbox" id="ciclo-disc-${d.id}">
            <label class="ciclo-disc-name" for="ciclo-disc-${d.id}">${d.nome}</label>
            <span class="ciclo-disc-peso">${pesoToShort(d.peso)} Peso ${d.peso}</span>
        </div>`
    ).join('');
    
    // Carregar horas da meta se existir
    document.getElementById('cicloHorasSemana').value = state.metas.horas || 49;
    
    // Carregar configura√ß√£o salva
    if(state.ultimoCicloConfig) {
        document.getElementById('cicloPassos').value = state.ultimoCicloConfig.totalPassos || 32;
        document.getElementById('cicloHorasSemana').value = state.ultimoCicloConfig.horasSemana || 49;
        
        // Marcar disciplinas que estavam selecionadas
        if(state.ultimoCicloConfig.distribuicao) {
            state.ultimoCicloConfig.distribuicao.forEach(d => {
                const cb = document.getElementById('ciclo-disc-' + d.id);
                if(cb) cb.checked = true;
            });
        }
    }
    
    // Restaurar ciclo gerado se existir
    if(state.ultimoCiclo && state.ultimoCiclo.length > 0) {
        restaurarCicloVisual();
    }
}

function restaurarCicloVisual() {
    if(!state.ultimoCiclo || !state.ultimoCicloConfig) return;
    
    const totalPassos = state.ultimoCiclo.length;
    const horasSemana = state.ultimoCicloConfig.horasSemana || 49;
    const distribuicao = state.ultimoCicloConfig.distribuicao || [];
    const progressoSalvo = state.cicloProgresso || [];
    
    // Restaurar gr√°fico de pizza
    if(distribuicao.length > 0) {
        renderPizzaChart(distribuicao);
        renderLegenda(distribuicao, horasSemana);
    }
    
    // Restaurar ciclo gerado
    document.getElementById('cicloResultado').innerHTML = 
        '<div class="ciclo-progress-bar"><div class="ciclo-progress-fill" id="cicloProgressFill" style="width:0%"></div></div>' +
        '<div class="ciclo-progress-info"><span id="cicloProgressText">0/' + totalPassos + ' passos</span><span id="cicloProgressPct">0%</span></div>' +
        '<div class="ciclo-grid">' + state.ultimoCiclo.map((item, i) => {
            const concluido = progressoSalvo[i] === true;
            const emAndamento = progressoSalvo[i] === 'andamento';
            return `<div class="ciclo-step ${concluido ? 'done' : ''} ${emAndamento ? 'current' : ''}" style="border-left-color:${item.cor}" data-step="${i}">
                <div class="ciclo-step-header">
                    <div class="ciclo-step-num">Passo ${i + 1}</div>
                    <div class="ciclo-step-actions">
                        <button class="ciclo-btn ${emAndamento ? 'active' : ''}" onclick="marcarEmAndamento(${i})" title="Em andamento">‚ñ∂</button>
                        <button class="ciclo-btn ${concluido ? 'active' : ''}" onclick="marcarConcluido(${i})" title="Conclu√≠do">‚úì</button>
                    </div>
                </div>
                <div class="ciclo-step-disc">${item.nome}</div>
                <div class="ciclo-step-tempo">‚è±Ô∏è ${item.minutos} min</div>
            </div>`;
        }).join('') + '</div>';
    
    // Resumo e bot√µes
    document.getElementById('cicloResumo').textContent = totalPassos + ' passos ‚Ä¢ ' + horasSemana + 'h/semana';
    document.getElementById('btnCopiarCiclo').style.display = 'inline-flex';
    document.getElementById('btnResetCiclo').style.display = 'inline-flex';
    
    atualizarProgressoCiclo();
}

function gerarCiclo() {
    const totalPassos = parseInt(document.getElementById('cicloPassos').value) || 32;
    const horasSemana = parseFloat(document.getElementById('cicloHorasSemana').value) || 49;
    
    // Pegar disciplinas selecionadas
    const discsSelecionadas = state.disciplinas.filter(d => {
        const cb = document.getElementById('ciclo-disc-' + d.id);
        return cb && cb.checked;
    });
    
    if(discsSelecionadas.length === 0) {
        showToast('Selecione ao menos uma disciplina!', 'error');
        return;
    }
    
    // Calcular distribui√ß√£o proporcional baseada no peso
    const totalPeso = discsSelecionadas.reduce((a, d) => a + d.peso, 0);
    let distribuicao = discsSelecionadas.map((d, i) => ({
        id: d.id,
        nome: d.nome,
        peso: d.peso,
        cor: CORES_CICLO[i % CORES_CICLO.length],
        passos: Math.round((d.peso / totalPeso) * totalPassos),
        pctTempo: (d.peso / totalPeso) * 100,
        horasSemana: (d.peso / totalPeso) * horasSemana
    }));
    
    // Ajustar para totalizar exatamente o n√∫mero de passos
    let somaPassos = distribuicao.reduce((a, d) => a + d.passos, 0);
    while(somaPassos !== totalPassos) {
        if(somaPassos < totalPassos) {
            const sorted = [...distribuicao].sort((a, b) => b.peso - a.peso);
            sorted[0].passos++;
            somaPassos++;
        } else {
            const sorted = [...distribuicao].sort((a, b) => a.peso - b.peso);
            const item = sorted.find(d => d.passos > 1);
            if(item) { item.passos--; somaPassos--; }
            else break;
        }
    }
    
    // Calcular minutos por passo para cada disciplina
    const minutosTotais = horasSemana * 60;
    distribuicao.forEach(d => {
        d.minutosPorPasso = Math.round((d.horasSemana * 60) / d.passos);
    });
    
    // Gerar gr√°fico de pizza SVG
    renderPizzaChart(distribuicao);
    
    // Gerar legenda
    renderLegenda(distribuicao, horasSemana);
    
    // Gerar ciclo com distribui√ß√£o espa√ßada
    const cicloDetalhado = gerarCicloEspacado(distribuicao, totalPassos);
    
    // Carregar progresso salvo
    const progressoSalvo = state.cicloProgresso || [];
    
    // Mostrar resultado
    document.getElementById('cicloResultado').innerHTML = 
        '<div class="ciclo-progress-bar"><div class="ciclo-progress-fill" id="cicloProgressFill" style="width:0%"></div></div>' +
        '<div class="ciclo-progress-info"><span id="cicloProgressText">0/' + totalPassos + ' passos</span><span id="cicloProgressPct">0%</span></div>' +
        '<div class="ciclo-grid">' + cicloDetalhado.map((item, i) => {
            const concluido = progressoSalvo[i] === true;
            const emAndamento = progressoSalvo[i] === 'andamento';
            return `<div class="ciclo-step ${concluido ? 'done' : ''} ${emAndamento ? 'current' : ''}" style="border-left-color:${item.cor}" data-step="${i}">
                <div class="ciclo-step-header">
                    <div class="ciclo-step-num">Passo ${i + 1}</div>
                    <div class="ciclo-step-actions">
                        <button class="ciclo-btn ${emAndamento ? 'active' : ''}" onclick="marcarEmAndamento(${i})" title="Em andamento">‚ñ∂</button>
                        <button class="ciclo-btn ${concluido ? 'active' : ''}" onclick="marcarConcluido(${i})" title="Conclu√≠do">‚úì</button>
                    </div>
                </div>
                <div class="ciclo-step-disc">${item.nome}</div>
                <div class="ciclo-step-tempo">‚è±Ô∏è ${item.minutos} min</div>
            </div>`;
        }).join('') + '</div>';
    
    atualizarProgressoCiclo();
    
    // Resumo
    document.getElementById('cicloResumo').textContent = `${totalPassos} passos ‚Ä¢ ${horasSemana}h/semana`;
    document.getElementById('btnCopiarCiclo').style.display = 'inline-flex';
    document.getElementById('btnResetCiclo').style.display = 'inline-flex';
    
    // Guardar ciclo no estado
    state.ultimoCiclo = cicloDetalhado;
    state.ultimoCicloConfig = { totalPassos, horasSemana, distribuicao };
    saveState();
    
    showToast('Ciclo gerado com ' + totalPassos + ' passos!');
}

function renderPizzaChart(distribuicao) {
    const size = 180;
    const center = size / 2;
    const radius = 70;
    
    let startAngle = -90; // Come√ßar do topo
    let paths = '';
    
    distribuicao.forEach(d => {
        const angle = (d.pctTempo / 100) * 360;
        const endAngle = startAngle + angle;
        
        // Converter para radianos
        const startRad = (startAngle * Math.PI) / 180;
        const endRad = (endAngle * Math.PI) / 180;
        
        // Calcular pontos
        const x1 = center + radius * Math.cos(startRad);
        const y1 = center + radius * Math.sin(startRad);
        const x2 = center + radius * Math.cos(endRad);
        const y2 = center + radius * Math.sin(endRad);
        
        // Large arc flag
        const largeArc = angle > 180 ? 1 : 0;
        
        paths += `<path d="M${center},${center} L${x1},${y1} A${radius},${radius} 0 ${largeArc},1 ${x2},${y2} Z" fill="${d.cor}" stroke="var(--bg-card)" stroke-width="2"/>`;
        
        startAngle = endAngle;
    });
    
    const svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">${paths}</svg>`;
    document.getElementById('cicloChart').innerHTML = svg;
}

function renderLegenda(distribuicao, horasSemana) {
    document.getElementById('cicloLegenda').innerHTML = distribuicao.map(d => {
        const horas = d.horasSemana;
        const horasInt = Math.floor(horas);
        const minutos = Math.round((horas - horasInt) * 60);
        const tempoStr = horasInt > 0 ? (minutos > 0 ? `${horasInt}h ${minutos}min` : `${horasInt}h`) : `${minutos}min`;
        
        return `<div class="ciclo-legenda-item">
            <div class="ciclo-legenda-cor" style="background:${d.cor}"></div>
            <div class="ciclo-legenda-info">
                <div>${d.nome}</div>
                <div class="ciclo-legenda-tempo">${d.passos} passos ‚Ä¢ ${tempoStr}/sem ‚Ä¢ ${d.pctTempo.toFixed(1)}%</div>
            </div>
        </div>`;
    }).join('');
}

function gerarCicloEspacado(distribuicao, totalPassos) {
    // Criar pool com info completa
    let pool = [];
    distribuicao.forEach(d => {
        for(let i = 0; i < d.passos; i++) {
            pool.push({ nome: d.nome, id: d.id, cor: d.cor, minutos: d.minutosPorPasso });
        }
    });
    
    // Algoritmo de espa√ßamento
    const ciclo = [];
    let lastId = null;
    
    for(let i = 0; i < totalPassos; i++) {
        let candidatos = pool.filter(p => p.id !== lastId);
        if(candidatos.length === 0) candidatos = pool;
        
        const contagem = {};
        candidatos.forEach(c => { contagem[c.id] = (contagem[c.id] || 0) + 1; });
        const maxCount = Math.max(...Object.values(contagem));
        const maisFrequentes = candidatos.filter(c => contagem[c.id] === maxCount);
        
        const escolhido = maisFrequentes[0];
        ciclo.push({ nome: escolhido.nome, cor: escolhido.cor, minutos: escolhido.minutos });
        lastId = escolhido.id;
        
        const idx = pool.findIndex(p => p.id === escolhido.id);
        if(idx > -1) pool.splice(idx, 1);
    }
    
    return ciclo;
}


function marcarEmAndamento(stepIndex) {
    if(!state.cicloProgresso) state.cicloProgresso = [];
    
    // Garantir que o array tenha o tamanho correto
    const totalPassos = state.ultimoCiclo?.length || 0;
    while(state.cicloProgresso.length < totalPassos) {
        state.cicloProgresso.push(false);
    }
    
    // Se j√° est√° em andamento, desmarcar
    if(state.cicloProgresso[stepIndex] === 'andamento') {
        state.cicloProgresso[stepIndex] = false;
    } else {
        // Limpar outros "em andamento" e marcar este
        for(let i = 0; i < state.cicloProgresso.length; i++) {
            if(state.cicloProgresso[i] === 'andamento') {
                state.cicloProgresso[i] = false;
            }
        }
        state.cicloProgresso[stepIndex] = 'andamento';
    }
    
    saveState();
    atualizarVisualCiclo();
}

function marcarConcluido(stepIndex) {
    if(!state.cicloProgresso) state.cicloProgresso = [];
    
    // Garantir que o array tenha o tamanho correto
    const totalPassos = state.ultimoCiclo?.length || 0;
    while(state.cicloProgresso.length < totalPassos) {
        state.cicloProgresso.push(false);
    }
    
    // Toggle conclu√≠do
    if(state.cicloProgresso[stepIndex] === true) {
        state.cicloProgresso[stepIndex] = false;
    } else {
        state.cicloProgresso[stepIndex] = true;
    }
    
    saveState();
    atualizarVisualCiclo();
}

function atualizarVisualCiclo() {
    const progresso = state.cicloProgresso || [];
    
    document.querySelectorAll('.ciclo-step').forEach((step, i) => {
        const concluido = progresso[i] === true;
        const emAndamento = progresso[i] === 'andamento';
        
        step.classList.toggle('done', concluido);
        step.classList.toggle('current', emAndamento);
        
        const btns = step.querySelectorAll('.ciclo-btn');
        if(btns[0]) btns[0].classList.toggle('active', emAndamento);
        if(btns[1]) btns[1].classList.toggle('active', concluido);
    });
    
    atualizarProgressoCiclo();
}

function atualizarProgressoCiclo() {
    const progresso = state.cicloProgresso || [];
    const total = state.ultimoCiclo?.length || 0;
    const concluidos = progresso.filter(p => p === true).length;
    const pct = total > 0 ? Math.round((concluidos / total) * 100) : 0;
    
    const fillEl = document.getElementById('cicloProgressFill');
    const textEl = document.getElementById('cicloProgressText');
    const pctEl = document.getElementById('cicloProgressPct');
    
    if(fillEl) fillEl.style.width = pct + '%';
    if(textEl) textEl.textContent = concluidos + '/' + total + ' passos';
    if(pctEl) pctEl.textContent = pct + '%';
}

function resetarProgressoCiclo() {
    if(!confirm('Resetar o progresso do ciclo?')) return;
    state.cicloProgresso = [];
    saveState();
    atualizarVisualCiclo();
    showToast('Progresso resetado!');
}

function copiarCiclo() {
    if(!state.ultimoCiclo || !state.ultimoCiclo.length) {
        showToast('Gere um ciclo primeiro!', 'error');
        return;
    }
    
    const texto = state.ultimoCiclo.map((d, i) => `${i + 1}. ${d.nome} (${d.minutos} min)`).join('\n');
    navigator.clipboard.writeText(texto).then(() => {
        showToast('Ciclo copiado!');
    }).catch(() => {
        showToast('Erro ao copiar', 'error');
    });
}




// METAS
function refreshMetas() {
    document.getElementById('metaHoras').value = state.metas.horas || 49;
    document.getElementById('metaTopicos').value = state.metas.topicos || 10;
    document.getElementById('metaQuestoes').value = state.metas.questoes || 100;
    document.getElementById('metaDataProva').value = state.metas.dataProva || '2026-02-22';
    
    atualizarContagemRegressiva();
    renderMetasProgresso();
}

function salvarMetas() {
    state.metas.horas = parseInt(document.getElementById('metaHoras').value) || 49;
    state.metas.topicos = parseInt(document.getElementById('metaTopicos').value) || 10;
    state.metas.questoes = parseInt(document.getElementById('metaQuestoes').value) || 100;
    saveState();
    showToast('Metas salvas!');
    renderMetasProgresso();
}

function salvarDataProva() {
    state.metas.dataProva = document.getElementById('metaDataProva').value;
    saveState();
    atualizarContagemRegressiva();
    showToast('Data salva!');
}

function atualizarContagemRegressiva() {
    const dataProva = state.metas.dataProva;
    if(!dataProva) {
        document.getElementById('diasRestantes').textContent = '--';
        return;
    }
    
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    const prova = new Date(dataProva + 'T00:00:00');
    const diff = Math.ceil((prova - hoje) / (1000 * 60 * 60 * 24));
    
    document.getElementById('diasRestantes').textContent = diff > 0 ? diff : 0;
    document.getElementById('diasRestantes').style.color = diff <= 7 ? 'var(--danger)' : diff <= 30 ? 'var(--warning)' : 'var(--accent)';
}

function renderMetasProgresso() {
    const ws = getWeekStart();
    const hoje = getToday();
    
    // Calcular progresso
    const minsSemana = state.sessoes.filter(s => s.data >= ws).reduce((a,s) => a + s.minutos, 0);
    const horasSemana = Math.round(minsSemana / 60 * 10) / 10;
    const topicosDominados = state.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'mastered').length, 0);
    const questoesSemana = state.questoes.filter(q => q.data >= ws).reduce((a,q) => a + q.total, 0);
    
    const metaH = state.metas.horas || 49;
    const metaT = state.metas.topicos || 10;
    const metaQ = state.metas.questoes || 100;
    
    const pctH = Math.min(100, Math.round((horasSemana / metaH) * 100));
    const pctT = Math.min(100, Math.round((topicosDominados / metaT) * 100));
    const pctQ = Math.min(100, Math.round((questoesSemana / metaQ) * 100));
    
    const corH = pctH >= 100 ? 'var(--success)' : pctH >= 70 ? 'var(--cyan)' : pctH >= 40 ? 'var(--warning)' : 'var(--danger)';
    const corT = pctT >= 100 ? 'var(--success)' : pctT >= 70 ? 'var(--cyan)' : pctT >= 40 ? 'var(--warning)' : 'var(--danger)';
    const corQ = pctQ >= 100 ? 'var(--success)' : pctQ >= 70 ? 'var(--cyan)' : pctQ >= 40 ? 'var(--warning)' : 'var(--danger)';
    
    document.getElementById('metasProgresso').innerHTML = `
        <div class="meta-progress-item">
            <div class="meta-progress-icon">‚è±Ô∏è</div>
            <div class="meta-progress-info">
                <div class="meta-progress-title">Horas de Estudo</div>
                <div class="meta-progress-bar"><div class="meta-progress-fill" style="width:${pctH}%;background:${corH}"></div></div>
                <div class="meta-progress-text">${horasSemana}h de ${metaH}h</div>
            </div>
            <div class="meta-progress-pct" style="color:${corH}">${pctH}%</div>
        </div>
        <div class="meta-progress-item">
            <div class="meta-progress-icon">üìñ</div>
            <div class="meta-progress-info">
                <div class="meta-progress-title">T√≥picos Dominados</div>
                <div class="meta-progress-bar"><div class="meta-progress-fill" style="width:${pctT}%;background:${corT}"></div></div>
                <div class="meta-progress-text">${topicosDominados} de ${metaT}</div>
            </div>
            <div class="meta-progress-pct" style="color:${corT}">${pctT}%</div>
        </div>
        <div class="meta-progress-item">
            <div class="meta-progress-icon">‚ùì</div>
            <div class="meta-progress-info">
                <div class="meta-progress-title">Quest√µes Resolvidas</div>
                <div class="meta-progress-bar"><div class="meta-progress-fill" style="width:${pctQ}%;background:${corQ}"></div></div>
                <div class="meta-progress-text">${questoesSemana} de ${metaQ}</div>
            </div>
            <div class="meta-progress-pct" style="color:${corQ}">${pctQ}%</div>
        </div>
    `;
}

// ESTAT√çSTICAS
function refreshStats() {
    // Totais gerais
    const totalMins = state.sessoes.reduce((a,s) => a + s.minutos, 0);
    const totalHoras = Math.round(totalMins / 60 * 10) / 10;
    const totalSessoes = state.sessoes.length;
    
    document.getElementById('statTotalHoras').textContent = totalHoras + 'h';
    document.getElementById('statTotalSessoes').textContent = totalSessoes;
    
    // Dias √∫nicos estudados
    const diasUnicos = [...new Set(state.sessoes.map(s => s.data))].length;
    document.getElementById('statDiasEstudados').textContent = diasUnicos;
    
    // M√©dia √∫ltimos 7 dias
    const hoje = new Date();
    const seteDiasAtras = new Date(hoje);
    seteDiasAtras.setDate(seteDiasAtras.getDate() - 7);
    const seteDiasStr = seteDiasAtras.toISOString().split('T')[0];
    
    const minsUltimos7 = state.sessoes.filter(s => s.data >= seteDiasStr).reduce((a,s) => a + s.minutos, 0);
    const mediaHoras = Math.round(minsUltimos7 / 7 / 60 * 10) / 10;
    document.getElementById('statMediaDiaria').textContent = mediaHoras + 'h';
    
    renderStatsPorDisciplina();
    renderStatsUltimos7Dias();
    renderStatsTopicos();
    renderStatsRevisoes();
    renderStatsComparativo();
    renderStatsPrevisao();
}

function renderStatsPorDisciplina() {
    const container = document.getElementById('statsPorDisciplina');
    
    // Agrupar por disciplina
    const porDisc = {};
    state.sessoes.forEach(s => {
        if(!porDisc[s.disciplinaId]) porDisc[s.disciplinaId] = 0;
        porDisc[s.disciplinaId] += s.minutos;
    });
    
    let lista = Object.entries(porDisc).map(([id, mins]) => {
        const disc = state.disciplinas.find(d => d.id === parseInt(id) || d.id === parseFloat(id));
        return { nome: disc?.nome || '?', minutos: mins, horas: Math.round(mins / 60 * 10) / 10 };
    }).sort((a,b) => b.minutos - a.minutos);
    
    if(lista.length === 0) {
        container.innerHTML = '<div class="empty" style="padding:20px"><div class="empty-icon">üìä</div><div>Registre sess√µes para ver estat√≠sticas</div></div>';
        return;
    }
    
    const maxMins = Math.max(...lista.map(d => d.minutos));
    
    container.innerHTML = lista.map(d => {
        const pct = (d.minutos / maxMins) * 100;
        return `<div class="stats-bar-container">
            <div class="stats-bar-header">
                <span class="stats-bar-name">${d.nome}</span>
                <span class="stats-bar-value">${d.horas}h</span>
            </div>
            <div class="stats-bar"><div class="stats-bar-fill" style="width:${pct}%;background:linear-gradient(90deg, var(--accent), #8b5cf6)"></div></div>
        </div>`;
    }).join('');
}

function renderStatsUltimos7Dias() {
    const container = document.getElementById('statsUltimos7Dias');
    
    const dias = [];
    const hoje = new Date();
    
    for(let i = 6; i >= 0; i--) {
        const d = new Date(hoje);
        d.setDate(d.getDate() - i);
        const dataStr = d.toISOString().split('T')[0];
        const mins = state.sessoes.filter(s => s.data === dataStr).reduce((a,s) => a + s.minutos, 0);
        dias.push({
            data: dataStr,
            label: d.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', ''),
            minutos: mins,
            horas: Math.round(mins / 60 * 10) / 10
        });
    }
    
    const maxMins = Math.max(...dias.map(d => d.minutos), 60);
    
    container.innerHTML = dias.map(d => {
        const altura = Math.max(2, (d.minutos / maxMins) * 100);
        return `<div class="stats-day-col">
            <div class="stats-day-value">${d.horas}h</div>
            <div class="stats-day-bar-wrap">
                <div class="stats-day-fill" style="height:${altura}px"></div>
            </div>
            <div class="stats-day-label">${d.label}</div>
        </div>`;
    }).join('');
}

function renderStatsTopicos() {
    const container = document.getElementById('statsTopicosStatus');
    
    const total = state.disciplinas.reduce((a,d) => a + d.topicos.length, 0);
    const naoEstudado = state.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'not-studied').length, 0);
    const estudado = state.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'studied').length, 0);
    const revisado = state.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'revised').length, 0);
    const dominado = state.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'mastered').length, 0);
    
    if(total === 0) {
        container.innerHTML = '<div class="empty" style="padding:20px"><div class="empty-icon">üìñ</div><div>Cadastre t√≥picos para ver estat√≠sticas</div></div>';
        return;
    }
    
    container.innerHTML = `
        <div class="stats-summary-item"><span class="stats-summary-label">üìö Total de T√≥picos</span><span class="stats-summary-value">${total}</span></div>
        <div class="stats-summary-item"><span class="stats-summary-label">‚¨ú N√£o Estudados</span><span class="stats-summary-value" style="color:var(--text-muted)">${naoEstudado}</span></div>
        <div class="stats-summary-item"><span class="stats-summary-label">üü£ Estudados</span><span class="stats-summary-value" style="color:var(--accent)">${estudado}</span></div>
        <div class="stats-summary-item"><span class="stats-summary-label">üü° Revisados</span><span class="stats-summary-value" style="color:var(--warning)">${revisado}</span></div>
        <div class="stats-summary-item"><span class="stats-summary-label">üü¢ Dominados</span><span class="stats-summary-value" style="color:var(--success)">${dominado}</span></div>
    `;
}


function renderStatsComparativo() {
    const container = document.getElementById('statsComparativo');
    
    // Calcular semana atual
    const hoje = new Date();
    const inicioSemanaAtual = getWeekStart();
    
    // Calcular semana anterior
    const inicioSemanaAnterior = new Date(inicioSemanaAtual);
    inicioSemanaAnterior.setDate(inicioSemanaAnterior.getDate() - 7);
    const inicioSemanaAnteriorStr = inicioSemanaAnterior.toISOString().split('T')[0];
    const fimSemanaAnteriorStr = inicioSemanaAtual;
    
    // Horas semana atual
    const horasAtual = Math.round(state.sessoes.filter(s => s.data >= inicioSemanaAtual).reduce((a,s) => a + s.minutos, 0) / 60 * 10) / 10;
    
    // Horas semana anterior
    const horasAnterior = Math.round(state.sessoes.filter(s => s.data >= inicioSemanaAnteriorStr && s.data < fimSemanaAnteriorStr).reduce((a,s) => a + s.minutos, 0) / 60 * 10) / 10;
    
    // Quest√µes semana atual
    const questoesAtual = state.questoes.filter(q => q.data >= inicioSemanaAtual).reduce((a,q) => a + q.total, 0);
    
    // Quest√µes semana anterior
    const questoesAnterior = state.questoes.filter(q => q.data >= inicioSemanaAnteriorStr && q.data < fimSemanaAnteriorStr).reduce((a,q) => a + q.total, 0);
    
    // Sess√µes semana atual
    const sessoesAtual = state.sessoes.filter(s => s.data >= inicioSemanaAtual).length;
    
    // Sess√µes semana anterior
    const sessoesAnterior = state.sessoes.filter(s => s.data >= inicioSemanaAnteriorStr && s.data < fimSemanaAnteriorStr).length;
    
    // Revis√µes semana atual
    const revisoesAtual = state.revisoes.filter(r => r.concluida && r.dataConclusao >= inicioSemanaAtual).length;
    
    // Revis√µes semana anterior
    const revisoesAnterior = state.revisoes.filter(r => r.concluida && r.dataConclusao >= inicioSemanaAnteriorStr && r.dataConclusao < fimSemanaAnteriorStr).length;
    
    function renderItem(label, atual, anterior, sufixo = '') {
        const diff = atual - anterior;
        const diffClass = diff > 0 ? 'up' : diff < 0 ? 'down' : 'same';
        const diffText = diff > 0 ? '+' + diff : diff.toString();
        const arrow = diff > 0 ? 'üìà' : diff < 0 ? 'üìâ' : '‚û°Ô∏è';
        
        return `<div class="comparativo-item">
            <span class="comparativo-label">${label}</span>
            <div class="comparativo-values">
                <span class="comparativo-old">${anterior}${sufixo}</span>
                <span class="comparativo-arrow">${arrow}</span>
                <span class="comparativo-new" style="color:${diff >= 0 ? 'var(--success)' : 'var(--danger)'}">${atual}${sufixo}</span>
                <span class="comparativo-diff ${diffClass}">${diffText}</span>
            </div>
        </div>`;
    }
    
    container.innerHTML = 
        renderItem('‚è±Ô∏è Horas', horasAtual, horasAnterior, 'h') +
        renderItem('üìù Sess√µes', sessoesAtual, sessoesAnterior) +
        renderItem('‚ùì Quest√µes', questoesAtual, questoesAnterior) +
        renderItem('üîÑ Revis√µes', revisoesAtual, revisoesAnterior);
}

function renderStatsPrevisao() {
    const container = document.getElementById('statsPrevisao');
    
    // Total de t√≥picos
    const totalTopicos = state.disciplinas.reduce((a,d) => a + d.topicos.length, 0);
    const topicosDominados = state.disciplinas.reduce((a,d) => a + d.topicos.filter(t => t.status === 'mastered').length, 0);
    const topicosRestantes = totalTopicos - topicosDominados;
    
    if(totalTopicos === 0) {
        container.innerHTML = '<div class="empty" style="padding:20px"><div class="empty-icon">üìñ</div><div>Cadastre t√≥picos para ver previs√£o</div></div>';
        return;
    }
    
    // Calcular ritmo m√©dio (t√≥picos dominados por semana nas √∫ltimas 4 semanas)
    // Simplificado: usar m√©dia geral
    const diasEstudo = [...new Set(state.sessoes.map(s => s.data))].length || 1;
    const semanasEstudo = Math.max(1, diasEstudo / 7);
    const topicosPorSemana = topicosDominados / semanasEstudo;
    
    let previsaoTexto = '';
    let diasPrevisao = 0;
    
    if(topicosPorSemana > 0) {
        const semanasRestantes = topicosRestantes / topicosPorSemana;
        diasPrevisao = Math.ceil(semanasRestantes * 7);
        
        const dataPrevisao = new Date();
        dataPrevisao.setDate(dataPrevisao.getDate() + diasPrevisao);
        previsaoTexto = dataPrevisao.toLocaleDateString('pt-BR');
    } else {
        previsaoTexto = 'Domine t√≥picos para calcular';
    }
    
    // Comparar com data da prova
    const dataProva = state.metas.dataProva;
    let alertaProva = '';
    if(dataProva && diasPrevisao > 0) {
        const prova = new Date(dataProva + 'T00:00:00');
        const hoje = new Date();
        const diasAteProva = Math.ceil((prova - hoje) / (1000 * 60 * 60 * 24));
        
        if(diasPrevisao > diasAteProva) {
            alertaProva = `<div style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.15);border-radius:8px;color:var(--danger);font-size:0.85rem;">‚ö†Ô∏è No ritmo atual, voc√™ terminar√° ${diasPrevisao - diasAteProva} dias ap√≥s a prova!</div>`;
        } else {
            alertaProva = `<div style="margin-top:12px;padding:12px;background:rgba(16,185,129,0.15);border-radius:8px;color:var(--success);font-size:0.85rem;">‚úÖ No ritmo atual, voc√™ terminar√° ${diasAteProva - diasPrevisao} dias antes da prova!</div>`;
        }
    }
    
    const pctConcluido = Math.round((topicosDominados / totalTopicos) * 100);
    
    container.innerHTML = `
        <div class="previsao-card">
            <div class="previsao-data">${previsaoTexto}</div>
            <div class="previsao-dias">${diasPrevisao > 0 ? 'em aproximadamente ' + diasPrevisao + ' dias' : ''}</div>
        </div>
        <div class="previsao-item"><span>üìö Total de T√≥picos</span><span>${totalTopicos}</span></div>
        <div class="previsao-item"><span>‚úÖ Dominados</span><span style="color:var(--success)">${topicosDominados}</span></div>
        <div class="previsao-item"><span>‚è≥ Restantes</span><span style="color:var(--warning)">${topicosRestantes}</span></div>
        <div class="previsao-item"><span>üìà Progresso</span><span style="color:var(--accent)">${pctConcluido}%</span></div>
        <div class="previsao-item"><span>üöÄ Ritmo</span><span>${topicosPorSemana.toFixed(1)} t√≥picos/semana</span></div>
        ${alertaProva}
    `;
}

function renderStatsRevisoes() {
    const container = document.getElementById('statsRevisoes');
    const hoje = getToday();
    
    const total = state.revisoes.length;
    const concluidas = state.revisoes.filter(r => r.concluida).length;
    const pendentes = state.revisoes.filter(r => !r.concluida && r.data >= hoje).length;
    const atrasadas = state.revisoes.filter(r => !r.concluida && r.data < hoje).length;
    const taxaConclusao = total > 0 ? Math.round((concluidas / total) * 100) : 0;
    
    container.innerHTML = `
        <div class="stats-summary-item"><span class="stats-summary-label">üìã Total de Revis√µes</span><span class="stats-summary-value">${total}</span></div>
        <div class="stats-summary-item"><span class="stats-summary-label">‚úÖ Conclu√≠das</span><span class="stats-summary-value" style="color:var(--success)">${concluidas}</span></div>
        <div class="stats-summary-item"><span class="stats-summary-label">‚è≥ Pendentes</span><span class="stats-summary-value" style="color:var(--warning)">${pendentes}</span></div>
        <div class="stats-summary-item"><span class="stats-summary-label">‚ö†Ô∏è Atrasadas</span><span class="stats-summary-value" style="color:var(--danger)">${atrasadas}</span></div>
        <div class="stats-summary-item"><span class="stats-summary-label">üìà Taxa de Conclus√£o</span><span class="stats-summary-value" style="color:var(--cyan)">${taxaConclusao}%</span></div>
    `;
}

// QUEST√ïES
function refreshQuestoes() {
    // Preencher select de disciplinas
    const sel = document.getElementById('questaoDisciplina');
    sel.innerHTML = '<option value="">Selecione</option>' + state.disciplinas.map(d => 
        `<option value="${d.id}">${d.nome}</option>`
    ).join('');
    
    // Data padr√£o = hoje
    document.getElementById('questaoData').value = getToday();
    
    // Calcular estat√≠sticas gerais
    const totalResp = state.questoes.reduce((a, q) => a + q.total, 0);
    const totalAcertos = state.questoes.reduce((a, q) => a + q.acertos, 0);
    const taxaGeral = totalResp > 0 ? Math.round((totalAcertos / totalResp) * 100) : 0;
    
    document.getElementById('qTotalRespondidas').textContent = totalResp;
    document.getElementById('qTotalAcertos').textContent = totalAcertos;
    document.getElementById('qTaxaGeral').textContent = taxaGeral + '%';
    
    // Calcular por disciplina
    renderQuestaoPorDisciplina();
    
    // Renderizar hist√≥rico
    renderQuestaoHistorico();
}

function renderQuestaoPorDisciplina() {
    const container = document.getElementById('questaoPorDisciplina');
    
    // Agrupar por disciplina
    const porDisc = {};
    state.questoes.forEach(q => {
        if(!porDisc[q.disciplinaId]) {
            porDisc[q.disciplinaId] = { total: 0, acertos: 0 };
        }
        porDisc[q.disciplinaId].total += q.total;
        porDisc[q.disciplinaId].acertos += q.acertos;
    });
    
    // Converter para array e calcular taxas
    let ranking = Object.entries(porDisc).map(([discId, dados]) => {
        const disc = state.disciplinas.find(d => d.id === parseInt(discId) || d.id === parseFloat(discId));
        return {
            id: discId,
            nome: disc?.nome || 'Disciplina removida',
            total: dados.total,
            acertos: dados.acertos,
            taxa: Math.round((dados.acertos / dados.total) * 100)
        };
    });
    
    if(ranking.length === 0) {
        container.innerHTML = '<div class="empty" style="padding:20px;"><div class="empty-icon">üìä</div><div>Registre quest√µes para ver estat√≠sticas</div></div>';
        return;
    }
    
    // Ordenar por taxa (pior primeiro para identificar pontos fracos)
    ranking.sort((a, b) => a.taxa - b.taxa);
    
    container.innerHTML = ranking.map((d, i) => {
        const cor = d.taxa < 50 ? 'var(--danger)' : d.taxa < 70 ? 'var(--warning)' : d.taxa < 85 ? 'var(--cyan)' : 'var(--success)';
        const emoji = d.taxa < 50 ? 'üî¥' : d.taxa < 70 ? 'üü†' : d.taxa < 85 ? 'üü°' : 'üü¢';
        return `<div class="disc-rank-item">
            <span class="disc-rank-pos">${emoji}</span>
            <span class="disc-rank-name">${d.nome}</span>
            <div class="disc-rank-bar"><div class="disc-rank-fill" style="width:${d.taxa}%;background:${cor}"></div></div>
            <span class="disc-rank-taxa" style="color:${cor}">${d.taxa}%</span>
            <span class="disc-rank-count">${d.acertos}/${d.total}</span>
        </div>`;
    }).join('');
}

function renderQuestaoHistorico() {
    const container = document.getElementById('questaoHistorico');
    const lista = [...state.questoes].sort((a, b) => b.data.localeCompare(a.data) || b.id - a.id);
    
    document.getElementById('questaoHistCount').textContent = lista.length + ' registros';
    
    if(lista.length === 0) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">üìù</div><div>Nenhum registro ainda</div></div>';
        return;
    }
    
    container.innerHTML = lista.slice(0, 50).map(q => {
        const disc = state.disciplinas.find(d => d.id === q.disciplinaId);
        const taxa = Math.round((q.acertos / q.total) * 100);
        const cor = taxa < 50 ? 'var(--danger)' : taxa < 70 ? 'var(--warning)' : taxa < 85 ? 'var(--cyan)' : 'var(--success)';
        const {full} = formatDate(q.data);
        
        return `<div class="questao-item">
            <div class="questao-data">${full}</div>
            <div class="questao-info">
                <div class="questao-disc">${disc?.nome || '?'}</div>
                <div class="questao-fonte">${q.fonte || 'Sem fonte'}</div>
            </div>
            <div class="questao-resultado">
                <div class="questao-taxa" style="color:${cor}">${taxa}%</div>
                <div class="questao-detalhe">${q.acertos}/${q.total}</div>
            </div>
            <button class="questao-delete" onclick="deletarQuestao(${q.id})">üóëÔ∏è</button>
        </div>`;
    }).join('');
}

function registrarQuestao() {
    const data = document.getElementById('questaoData').value;
    const disciplinaId = parseFloat(document.getElementById('questaoDisciplina').value);
    const fonte = document.getElementById('questaoFonte').value.trim();
    const total = parseInt(document.getElementById('questaoTotal').value);
    const acertos = parseInt(document.getElementById('questaoAcertos').value);
    
    if(!data || !disciplinaId || !total || isNaN(acertos)) {
        showToast('Preencha os campos obrigat√≥rios!', 'error');
        return;
    }
    
    if(acertos > total) {
        showToast('Acertos n√£o pode ser maior que o total!', 'error');
        return;
    }
    
    const questao = {
        id: Date.now(),
        data,
        disciplinaId,
        fonte,
        total,
        acertos
    };
    
    state.questoes.push(questao);
    saveState();
    
    // Limpar campos
    document.getElementById('questaoFonte').value = '';
    document.getElementById('questaoTotal').value = '';
    document.getElementById('questaoAcertos').value = '';
    
    const taxa = Math.round((acertos / total) * 100);
    showToast(`Registrado: ${acertos}/${total} (${taxa}%)`);
    
    refreshQuestoes();
}

function deletarQuestao(id) {
    if(!confirm('Excluir este registro?')) return;
    state.questoes = state.questoes.filter(q => q.id !== id);
    saveState();
    showToast('Registro exclu√≠do');
    refreshQuestoes();
}

// CONFIGURA√á√ïES
function refreshConfig() {
    // Carregar intervalos atuais
    document.getElementById('configIntervalos').value = state.intervalos.join(', ');
    
    // Mostrar estat√≠sticas
    const stats = [
        { label: 'Disciplinas', value: state.disciplinas.length, icon: 'üìö' },
        { label: 'T√≥picos', value: state.disciplinas.reduce((a,d) => a + d.topicos.length, 0), icon: 'üìñ' },
        { label: 'Sess√µes', value: state.sessoes.length, icon: 'üìù' },
        { label: 'Revis√µes', value: state.revisoes.length, icon: 'üîÑ' },
        { label: 'Quest√µes', value: state.questoes.reduce((a,q) => a + q.total, 0), icon: '‚ùì' },
        { label: 'Horas Totais', value: Math.round(state.sessoes.reduce((a,s) => a + s.minutos, 0) / 60 * 10) / 10 + 'h', icon: '‚è±Ô∏è' }
    ];
    
    document.getElementById('configStats').innerHTML = stats.map(s => 
        `<div style="background:var(--bg-primary);padding:16px;border-radius:8px;text-align:center;">
            <div style="font-size:1.5rem;margin-bottom:4px;">${s.icon}</div>
            <div style="font-size:1.25rem;font-weight:700;color:var(--accent);">${s.value}</div>
            <div style="font-size:0.75rem;color:var(--text-muted);">${s.label}</div>
        </div>`
    ).join('');
}

function exportarDados() {
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'estudospro-backup-' + getToday() + '.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Backup exportado!');
}

function importarDados(event) {
    const file = event.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const dados = JSON.parse(e.target.result);
            if(confirm('Isso substituir√° todos os dados atuais. Continuar?')) {
                state = { ...defaultState, ...dados };
                saveState();
                showToast('Dados importados com sucesso!');
                refreshConfig();
                refreshDashboard();
            }
        } catch(err) {
            showToast('Arquivo inv√°lido!', 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function salvarIntervalos() {
    const input = document.getElementById('configIntervalos').value;
    const intervalos = input.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n > 0);
    
    if(intervalos.length === 0) {
        showToast('Digite intervalos v√°lidos!', 'error');
        return;
    }
    
    state.intervalos = intervalos.sort((a,b) => a - b);
    saveState();
    showToast('Intervalos salvos: ' + state.intervalos.join(', ') + ' dias');
}

function limparTodosDados() {
    if(!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso apagar√° TODOS os seus dados permanentemente!')) return;
    if(!confirm('Tem certeza ABSOLUTA? Esta a√ß√£o n√£o pode ser desfeita!')) return;
    
    localStorage.removeItem(STORAGE_KEY);
    // Criar estado completamente novo (n√£o apenas spread)
    state = { 
        disciplinas: [], 
        sessoes: [], 
        revisoes: [], 
        questoes: [], 
        metas: { horas: 49, topicos: 10, questoes: 100, dataProva: '2026-02-22' }, 
        intervalos: [1, 3, 7, 14, 30], 
        cicloProgresso: [],
        badgesEarned: [],
        tema: state.tema || 'dark'
    };
    saveState();
    showToast('Todos os dados foram apagados!');
    refreshConfig();
    refreshDashboard();
}

function limparSessoes() {
    if(!confirm('Isso apagar√° todas as sess√µes e revis√µes, mas manter√° as disciplinas. Continuar?')) return;
    
    state.sessoes = [];
    state.revisoes = [];
    state.questoes = [];
    state.cicloProgresso = [];
    saveState();
    showToast('Sess√µes e revis√µes apagadas!');
    refreshConfig();
    refreshDashboard();
}

document.addEventListener('DOMContentLoaded', () => { loadTheme(); refreshDashboard(); });

// Mobile Menu
function toggleMobileMenu() {
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.getElementById('mobileOverlay');
    if(sidebar && overlay) {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('open');
    }
}

// Fechar menu ao clicar em item do menu
document.querySelectorAll('.nav-item').forEach(function(item) {
    item.addEventListener('click', function() {
        if(window.innerWidth <= 768) {
            var sidebar = document.querySelector('.sidebar');
            var overlay = document.getElementById('mobileOverlay');
            if(sidebar) sidebar.classList.remove('open');
            if(overlay) overlay.classList.remove('open');
        }
    });
});
</script>
</body>
</html>
